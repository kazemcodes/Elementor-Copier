<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paste Interceptor Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #92003B;
      padding-bottom: 10px;
    }
    h2 {
      color: #92003B;
      margin-top: 30px;
    }
    .test-section {
      background: #f9f9f9;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
      border-left: 4px solid #92003B;
    }
    .test-area {
      background: white;
      border: 2px dashed #ccc;
      padding: 20px;
      margin: 10px 0;
      min-height: 100px;
      border-radius: 4px;
    }
    .test-area:focus {
      border-color: #92003B;
      outline: none;
    }
    button {
      background: #92003B;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #750030;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #e9ecef;
    }
    .log-entry.info { color: #0c5460; }
    .log-entry.success { color: #155724; }
    .log-entry.error { color: #721c24; }
    .log-entry.warn { color: #856404; }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    .instructions {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .instructions h3 {
      margin-top: 0;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Paste Interceptor Test Suite</h1>
    <p>Test the paste interceptor module for keyboard shortcuts (Ctrl+V / Cmd+V)</p>

    <div class="instructions">
      <h3>üìã Test Instructions</h3>
      <ol>
        <li>Click "Simulate Extension Data in Clipboard" to add test data</li>
        <li>Click in the test area below and press <code>Ctrl+V</code> (or <code>Cmd+V</code> on Mac)</li>
        <li>The paste should be intercepted and a notification should appear</li>
        <li>Check the console log for detailed information</li>
      </ol>
    </div>

    <!-- Test Section 1: Basic Keyboard Interception -->
    <div class="test-section">
      <h2>Test 1: Keyboard Paste Interception (Ctrl+V / Cmd+V)</h2>
      <p>This test verifies that the paste interceptor can detect and intercept keyboard paste shortcuts.</p>
      
      <button onclick="simulateExtensionData()">Simulate Extension Data in Clipboard</button>
      <button onclick="clearClipboard()">Clear Clipboard</button>
      <button onclick="checkClipboard()">Check Clipboard</button>
      
      <div id="status1" class="status info" style="display:none;"></div>
      
      <div class="test-area" contenteditable="true" id="testArea1">
        Click here and press Ctrl+V (or Cmd+V) to test paste interception...
      </div>
    </div>

    <!-- Test Section 2: shouldHandlePaste() -->
    <div class="test-section">
      <h2>Test 2: shouldHandlePaste() Method</h2>
      <p>This test verifies that the interceptor correctly identifies extension data in the clipboard.</p>
      
      <button onclick="testShouldHandlePaste()">Test shouldHandlePaste()</button>
      
      <div id="status2" class="status info" style="display:none;"></div>
    </div>

    <!-- Test Section 3: Event Prevention -->
    <div class="test-section">
      <h2>Test 3: Event Prevention</h2>
      <p>This test verifies that default paste behavior is prevented when extension data is detected.</p>
      
      <button onclick="testEventPrevention()">Run Event Prevention Test</button>
      
      <div id="status3" class="status info" style="display:none;"></div>
      
      <div class="test-area" contenteditable="true" id="testArea3">
        Test area for event prevention...
      </div>
    </div>

    <!-- Console Log -->
    <div class="test-section">
      <h2>üìù Console Log</h2>
      <button onclick="clearLog()">Clear Log</button>
      <div id="consoleLog" class="log"></div>
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="clipboard-manager.js"></script>
  <script src="elementor-editor-detector.js"></script>
  <script src="paste-interceptor.js"></script>

  <script>
    // Mock Elementor editor environment
    window.elementor = {
      config: {
        version: '3.16.0',
        document: {
          id: 123,
          type: 'page'
        }
      }
    };
    window.elementorFrontend = {
      config: {
        version: '3.16.0'
      }
    };

    // Initialize components
    let clipboardManager;
    let editorDetector;
    let pasteInterceptor;

    // Console log capture
    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;

    function addLogEntry(message, type = 'info') {
      const logDiv = document.getElementById('consoleLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    console.log = function(...args) {
      originalConsoleLog.apply(console, args);
      addLogEntry(args.join(' '), 'info');
    };

    console.error = function(...args) {
      originalConsoleError.apply(console, args);
      addLogEntry(args.join(' '), 'error');
    };

    console.warn = function(...args) {
      originalConsoleWarn.apply(console, args);
      addLogEntry(args.join(' '), 'warn');
    };

    // Initialize
    async function init() {
      try {
        clipboardManager = new ClipboardManager();
        editorDetector = new ElementorEditorDetector();
        pasteInterceptor = new PasteInterceptor();

        console.log('‚úì Components initialized');
        console.log('Editor detected:', editorDetector.isElementorEditor());
        console.log('Elementor version:', editorDetector.getElementorVersion());

        // Initialize paste interceptor
        const success = await pasteInterceptor.initialize(clipboardManager, editorDetector);
        if (success) {
          console.log('‚úì Paste interceptor initialized successfully');
        } else {
          console.error('‚úó Paste interceptor initialization failed');
        }
      } catch (error) {
        console.error('Initialization error:', error);
      }
    }

    // Test functions
    async function simulateExtensionData() {
      try {
        const testData = {
          version: '1.0.0',
          type: 'elementor-copier',
          elementType: 'widget',
          data: {
            id: 'test123',
            elType: 'widget',
            widgetType: 'heading',
            settings: {
              title: 'Test Heading',
              header_size: 'h2'
            }
          },
          metadata: {
            sourceUrl: 'https://example.com',
            copiedAt: new Date().toISOString(),
            elementorVersion: '3.16.0'
          }
        };

        await clipboardManager.writeMultiFormat(testData);
        showStatus('status1', 'Extension data written to clipboard!', 'success');
        console.log('‚úì Test data written to clipboard');
      } catch (error) {
        showStatus('status1', 'Failed to write to clipboard: ' + error.message, 'error');
        console.error('‚úó Failed to write test data:', error);
      }
    }

    async function clearClipboard() {
      try {
        await navigator.clipboard.writeText('');
        showStatus('status1', 'Clipboard cleared', 'info');
        console.log('Clipboard cleared');
      } catch (error) {
        showStatus('status1', 'Failed to clear clipboard: ' + error.message, 'error');
        console.error('Failed to clear clipboard:', error);
      }
    }

    async function checkClipboard() {
      try {
        const hasData = await clipboardManager.hasExtensionData();
        const data = await clipboardManager.readExtensionData();
        
        if (hasData && data) {
          showStatus('status1', `Extension data found: ${data.elementType}`, 'success');
          console.log('‚úì Extension data found:', data);
        } else {
          showStatus('status1', 'No extension data in clipboard', 'info');
          console.log('No extension data in clipboard');
        }
      } catch (error) {
        showStatus('status1', 'Failed to check clipboard: ' + error.message, 'error');
        console.error('Failed to check clipboard:', error);
      }
    }

    async function testShouldHandlePaste() {
      try {
        // First, add extension data
        await simulateExtensionData();
        
        // Wait a bit for clipboard to update
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Test shouldHandlePaste
        const shouldHandle = await pasteInterceptor.shouldHandlePaste();
        
        if (shouldHandle) {
          showStatus('status2', '‚úì shouldHandlePaste() correctly detected extension data', 'success');
          console.log('‚úì shouldHandlePaste() returned true');
        } else {
          showStatus('status2', '‚úó shouldHandlePaste() failed to detect extension data', 'error');
          console.error('‚úó shouldHandlePaste() returned false');
        }
        
        // Test with empty clipboard
        await clearClipboard();
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const shouldHandleEmpty = await pasteInterceptor.shouldHandlePaste();
        
        if (!shouldHandleEmpty) {
          showStatus('status2', '‚úì shouldHandlePaste() correctly returned false for empty clipboard', 'success');
          console.log('‚úì shouldHandlePaste() correctly returned false');
        } else {
          showStatus('status2', '‚úó shouldHandlePaste() incorrectly returned true for empty clipboard', 'error');
          console.error('‚úó shouldHandlePaste() incorrectly returned true');
        }
      } catch (error) {
        showStatus('status2', 'Test failed: ' + error.message, 'error');
        console.error('Test failed:', error);
      }
    }

    async function testEventPrevention() {
      try {
        showStatus('status3', 'Test running... Add extension data and try pasting in the test area', 'info');
        await simulateExtensionData();
        console.log('Event prevention test ready. Try pasting in test area 3.');
      } catch (error) {
        showStatus('status3', 'Test setup failed: ' + error.message, 'error');
        console.error('Test setup failed:', error);
      }
    }

    function showStatus(elementId, message, type) {
      const statusEl = document.getElementById(elementId);
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
      
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 5000);
    }

    function clearLog() {
      document.getElementById('consoleLog').innerHTML = '';
    }

    // Initialize on load
    window.addEventListener('load', init);
  </script>
</body>
</html>
