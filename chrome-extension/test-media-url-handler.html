<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media URL Handler Test Suite</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #92003b;
      padding-bottom: 10px;
    }
    h2 {
      color: #92003b;
      margin-top: 30px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #ccc;
    }
    .test-result.pass {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    .test-result.fail {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    .test-result.info {
      background: #d1ecf1;
      border-left-color: #17a2b8;
      color: #0c5460;
    }
    button {
      background: #92003b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #6d002c;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #92003b;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¬ Media URL Handler Test Suite</h1>
  
  <div class="test-section">
    <h2>Test Controls</h2>
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
  </div>

  <div id="results"></div>

  <script src="media-url-handler.js"></script>
  <script>
    const handler = new MediaURLHandler();
    let testResults = [];

    // Test data
    const sampleElementData = {
      elType: 'section',
      id: 'test123',
      settings: {
        background_image: {
          url: '/wp-content/uploads/2024/01/background.jpg'
        }
      },
      elements: [
        {
          elType: 'column',
          id: 'col123',
          settings: {},
          elements: [
            {
              elType: 'widget',
              widgetType: 'image',
              id: 'img123',
              settings: {
                image: {
                  url: 'https://example.com/images/photo.jpg'
                }
              }
            },
            {
              elType: 'widget',
              widgetType: 'video',
              id: 'vid123',
              settings: {
                video_link: '//cdn.example.com/videos/demo.mp4',
                poster: {
                  url: '/uploads/poster.png'
                }
              }
            },
            {
              elType: 'widget',
              widgetType: 'heading',
              id: 'head123',
              settings: {
                title: 'Test Heading',
                _custom_css: 'selector { background: url("/images/bg.png"); }'
              }
            }
          ]
        }
      ]
    };

    function addResult(testName, passed, message, data = null) {
      testResults.push({ testName, passed, message, data });
      displayResults();
    }

    function displayResults() {
      const resultsDiv = document.getElementById('results');
      let html = '<div class="test-section"><h2>Test Results</h2>';
      
      const passed = testResults.filter(r => r.passed).length;
      const failed = testResults.filter(r => !r.passed).length;
      
      html += `
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value">${testResults.length}</div>
            <div class="stat-label">Total Tests</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: #28a745;">${passed}</div>
            <div class="stat-label">Passed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: #dc3545;">${failed}</div>
            <div class="stat-label">Failed</div>
          </div>
        </div>
      `;

      testResults.forEach(result => {
        const className = result.passed ? 'pass' : 'fail';
        const icon = result.passed ? 'âœ“' : 'âœ—';
        html += `
          <div class="test-result ${className}">
            <strong>${icon} ${result.testName}</strong><br>
            ${result.message}
            ${result.data ? `<pre>${JSON.stringify(result.data, null, 2)}</pre>` : ''}
          </div>
        `;
      });

      html += '</div>';
      resultsDiv.innerHTML = html;
    }

    function clearResults() {
      testResults = [];
      document.getElementById('results').innerHTML = '';
    }

    // Test 1: Extract media URLs from element data
    function testExtractMediaURLs() {
      console.log('Test 1: Extract media URLs');
      
      const mediaURLs = handler.extractMediaURLs(sampleElementData);
      
      const passed = mediaURLs.length > 0;
      addResult(
        'Extract Media URLs',
        passed,
        `Found ${mediaURLs.length} media URLs in element data`,
        mediaURLs
      );
    }

    // Test 2: Detect different media types
    function testMediaTypeDetection() {
      console.log('Test 2: Media type detection');
      
      const mediaURLs = handler.extractMediaURLs(sampleElementData);
      const types = [...new Set(mediaURLs.map(m => m.type))];
      
      const passed = types.length > 0;
      addResult(
        'Media Type Detection',
        passed,
        `Detected ${types.length} different media types: ${types.join(', ')}`,
        { types, mediaURLs }
      );
    }

    // Test 3: Convert relative URLs to absolute
    function testConvertToAbsolute() {
      console.log('Test 3: Convert to absolute URLs');
      
      const mediaURLs = handler.extractMediaURLs(sampleElementData);
      const absoluteURLs = handler.convertToAbsoluteURLs(mediaURLs, 'https://source-site.com');
      
      const allAbsolute = absoluteURLs.every(item => 
        item.url.startsWith('http://') || item.url.startsWith('https://')
      );
      
      addResult(
        'Convert to Absolute URLs',
        allAbsolute,
        allAbsolute 
          ? 'All URLs successfully converted to absolute format'
          : 'Some URLs are not absolute',
        absoluteURLs
      );
    }

    // Test 4: Detect external URLs
    function testExternalURLDetection() {
      console.log('Test 4: External URL detection');
      
      const mediaURLs = handler.extractMediaURLs(sampleElementData);
      const absoluteURLs = handler.convertToAbsoluteURLs(mediaURLs, 'https://source-site.com');
      
      const externalURLs = absoluteURLs.filter(item => item.isExternal);
      const internalURLs = absoluteURLs.filter(item => !item.isExternal);
      
      addResult(
        'External URL Detection',
        true,
        `Found ${externalURLs.length} external URLs and ${internalURLs.length} internal URLs`,
        { externalURLs, internalURLs }
      );
    }

    // Test 5: Update element URLs
    function testUpdateElementURLs() {
      console.log('Test 5: Update element URLs');
      
      const updatedData = handler.updateElementURLs(sampleElementData, 'https://source-site.com');
      const updatedURLs = handler.extractMediaURLs(updatedData);
      
      const allAbsolute = updatedURLs.every(item => 
        item.url.startsWith('http://') || item.url.startsWith('https://')
      );
      
      addResult(
        'Update Element URLs',
        allAbsolute,
        allAbsolute
          ? 'Element data successfully updated with absolute URLs'
          : 'Some URLs in element data are not absolute',
        { originalCount: handler.extractMediaURLs(sampleElementData).length, updatedCount: updatedURLs.length }
      );
    }

    // Test 6: Extract URLs from CSS
    function testCSSURLExtraction() {
      console.log('Test 6: CSS URL extraction');
      
      const mediaURLs = handler.extractMediaURLs(sampleElementData);
      const cssURLs = mediaURLs.filter(item => item.type === 'css-background');
      
      const passed = cssURLs.length > 0;
      addResult(
        'CSS URL Extraction',
        passed,
        passed
          ? `Successfully extracted ${cssURLs.length} URL(s) from CSS`
          : 'No URLs found in CSS (expected at least 1)',
        cssURLs
      );
    }

    // Test 7: Create media notification
    function testCreateNotification() {
      console.log('Test 7: Create media notification');
      
      const mediaURLs = handler.extractMediaURLs(sampleElementData);
      const absoluteURLs = handler.convertToAbsoluteURLs(mediaURLs, 'https://source-site.com');
      const notification = handler.createMediaNotification(absoluteURLs);
      
      const passed = notification !== null && notification.type === 'warning';
      addResult(
        'Create Media Notification',
        passed,
        passed
          ? 'Notification created successfully for external media'
          : 'Failed to create notification',
        notification
      );
    }

    // Test 8: Get media statistics
    function testMediaStatistics() {
      console.log('Test 8: Media statistics');
      
      const mediaURLs = handler.extractMediaURLs(sampleElementData);
      const absoluteURLs = handler.convertToAbsoluteURLs(mediaURLs, 'https://source-site.com');
      const stats = handler.getMediaStatistics(absoluteURLs);
      
      const passed = stats.total === mediaURLs.length;
      addResult(
        'Media Statistics',
        passed,
        `Statistics: ${stats.total} total, ${stats.external} external, ${Object.keys(stats.byType).length} types`,
        stats
      );
    }

    // Test 9: Handle nested elements
    function testNestedElements() {
      console.log('Test 9: Handle nested elements');
      
      const nestedData = {
        elType: 'section',
        settings: {
          background_image: { url: 'https://example.com/bg1.jpg' }
        },
        elements: [
          {
            elType: 'column',
            settings: {
              background_image: { url: 'https://example.com/bg2.jpg' }
            },
            elements: [
              {
                elType: 'widget',
                widgetType: 'image',
                settings: {
                  image: { url: 'https://example.com/img.jpg' }
                }
              }
            ]
          }
        ]
      };
      
      const mediaURLs = handler.extractMediaURLs(nestedData);
      const passed = mediaURLs.length === 3;
      
      addResult(
        'Handle Nested Elements',
        passed,
        passed
          ? 'Successfully extracted URLs from all nesting levels'
          : `Expected 3 URLs, found ${mediaURLs.length}`,
        mediaURLs
      );
    }

    // Test 10: Handle empty/null data
    function testEdgeCases() {
      console.log('Test 10: Edge cases');
      
      const tests = [
        { data: null, expected: 0, name: 'null data' },
        { data: {}, expected: 0, name: 'empty object' },
        { data: { elType: 'widget', settings: {} }, expected: 0, name: 'no media' }
      ];
      
      let allPassed = true;
      const results = [];
      
      tests.forEach(test => {
        const mediaURLs = handler.extractMediaURLs(test.data);
        const passed = mediaURLs.length === test.expected;
        allPassed = allPassed && passed;
        results.push({ name: test.name, passed, count: mediaURLs.length });
      });
      
      addResult(
        'Edge Cases',
        allPassed,
        allPassed
          ? 'All edge cases handled correctly'
          : 'Some edge cases failed',
        results
      );
    }

    async function runAllTests() {
      clearResults();
      
      addResult('Test Suite', true, 'Starting Media URL Handler tests...', null);
      
      testExtractMediaURLs();
      testMediaTypeDetection();
      testConvertToAbsolute();
      testExternalURLDetection();
      testUpdateElementURLs();
      testCSSURLExtraction();
      testCreateNotification();
      testMediaStatistics();
      testNestedElements();
      testEdgeCases();
      
      addResult('Test Suite', true, 'All tests completed!', null);
    }

    // Auto-run tests on load
    window.addEventListener('load', () => {
      console.log('Media URL Handler Test Suite loaded');
    });
  </script>
</body>
</html>
