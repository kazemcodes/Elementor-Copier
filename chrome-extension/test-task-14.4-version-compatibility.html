<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task 14.4 - Version Compatibility in Paste Flow Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #2196f3;
      padding-bottom: 10px;
    }
    h2 {
      color: #2196f3;
      margin-top: 0;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #2196f3;
    }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #1976d2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .success {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      color: #2e7d32;
    }
    .error {
      background: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
    }
    .info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      color: #1565c0;
    }
    .warning {
      background: #fff3e0;
      border: 1px solid #ff9800;
      color: #e65100;
    }
    .test-data {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .requirement {
      background: #fff9c4;
      padding: 8px;
      margin: 10px 0;
      border-left: 3px solid #fbc02d;
      font-size: 13px;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.pass {
      background: #4caf50;
      color: white;
    }
    .status.fail {
      background: #f44336;
      color: white;
    }
    .status.pending {
      background: #ff9800;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Task 14.4: Version Compatibility in Paste Flow Test</h1>

  <div class="test-container">
    <h2>Requirements Verification</h2>
    <div class="requirement">
      <strong>Requirement 9.2:</strong> Detect target Elementor version during paste
      <span class="status pending" id="req-9-2">PENDING</span>
    </div>
    <div class="requirement">
      <strong>Requirement 9.3:</strong> Apply version conversion rules before injecting
      <span class="status pending" id="req-9-3">PENDING</span>
    </div>
    <div class="requirement">
      <strong>Requirement 9.4:</strong> Show compatibility notifications to user
      <span class="status pending" id="req-9-4">PENDING</span>
    </div>
    <div class="requirement">
      <strong>Requirement 8.3:</strong> Show compatibility notifications to user
      <span class="status pending" id="req-8-3">PENDING</span>
    </div>
  </div>

  <div class="test-container">
    <h2>Test 1: Version Detection</h2>
    <p>Test that target Elementor version is detected during paste operation</p>
    <button onclick="testVersionDetection()">Run Test</button>
    <div id="test1-result"></div>
  </div>

  <div class="test-container">
    <h2>Test 2: Version Compatibility Check</h2>
    <p>Test that version compatibility is checked between source and target</p>
    <button onclick="testVersionCompatibilityCheck()">Run Test</button>
    <div id="test2-result"></div>
  </div>

  <div class="test-container">
    <h2>Test 3: Version Conversion Rules</h2>
    <p>Test that conversion rules are applied when versions differ</p>
    <button onclick="testVersionConversionRules()">Run Test</button>
    <div id="test3-result"></div>
  </div>

  <div class="test-container">
    <h2>Test 4: Compatibility Notifications</h2>
    <p>Test that notifications are shown for version compatibility</p>
    <button onclick="testCompatibilityNotifications()">Run Test</button>
    <div id="test4-result"></div>
  </div>

  <div class="test-container">
    <h2>Test 5: Integration Test - Complete Paste Flow</h2>
    <p>Test the complete paste flow with version compatibility checks</p>
    <button onclick="testCompletePasteFlow()">Run Test</button>
    <div id="test5-result"></div>
  </div>

  <div class="test-container">
    <h2>Test 6: Edge Cases</h2>
    <p>Test edge cases like unknown versions, same versions, and incompatible versions</p>
    <button onclick="testEdgeCases()">Run Test</button>
    <div id="test6-result"></div>
  </div>

  <script src="version-compatibility.js"></script>
  <script src="notification-manager.js"></script>
  <script src="elementor-format-converter.js"></script>
  <script src="clipboard-manager.js"></script>
  <script src="elementor-editor-detector.js"></script>
  <script src="editor-injector.js"></script>
  <script src="media-url-handler.js"></script>
  <script src="paste-interceptor.js"></script>

  <script>
    // Mock Elementor environment
    window.elementor = {
      config: {
        version: '3.5.2',
        document: {
          id: 123
        }
      }
    };

    window.elementorFrontend = {
      config: {
        version: '3.5.2'
      }
    };

    // Helper function to display results
    function displayResult(elementId, result, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="result ${type}">${result}</div>`;
    }

    // Helper function to update requirement status
    function updateRequirementStatus(reqId, status) {
      const element = document.getElementById(reqId);
      element.className = `status ${status}`;
      element.textContent = status.toUpperCase();
    }

    // Test 1: Version Detection
    async function testVersionDetection() {
      displayResult('test1-result', 'Running test...', 'info');
      
      try {
        // Create mock instances
        const editorDetector = new ElementorEditorDetector();
        const editorInjector = new EditorContextInjector();
        
        // Initialize
        await editorInjector.initialize();
        
        // Get version
        const version = await editorInjector.getElementorVersion();
        
        if (version && version !== 'unknown') {
          displayResult('test1-result', 
            `✓ PASS: Target version detected: ${version}\n\n` +
            `Expected: Version string (e.g., "3.5.2")\n` +
            `Actual: ${version}`,
            'success'
          );
          updateRequirementStatus('req-9-2', 'pass');
          return true;
        } else {
          displayResult('test1-result', 
            `✗ FAIL: Could not detect target version\n\n` +
            `Expected: Version string\n` +
            `Actual: ${version}`,
            'error'
          );
          updateRequirementStatus('req-9-2', 'fail');
          return false;
        }
      } catch (error) {
        displayResult('test1-result', 
          `✗ ERROR: ${error.message}\n\n${error.stack}`,
          'error'
        );
        updateRequirementStatus('req-9-2', 'fail');
        return false;
      }
    }

    // Test 2: Version Compatibility Check
    async function testVersionCompatibilityCheck() {
      displayResult('test2-result', 'Running test...', 'info');
      
      try {
        const versionManager = new VersionCompatibilityManager();
        
        // Test compatible versions
        const test1 = versionManager.isCompatible('3.5.0', '3.5.2');
        const test2 = versionManager.isCompatible('3.0.0', '3.5.0');
        const test3 = versionManager.isCompatible('2.9.0', '3.5.0');
        const test4 = versionManager.isCompatible('2.9.0', '4.0.0');
        
        let results = '';
        results += `Test 1 (3.5.0 → 3.5.2): ${test1.compatible ? '✓' : '✗'} ${test1.message}\n`;
        results += `Test 2 (3.0.0 → 3.5.0): ${test2.compatible ? '✓' : '✗'} ${test2.message}\n`;
        results += `Test 3 (2.9.0 → 3.5.0): ${test3.compatible ? '✓' : '✗'} ${test3.message}\n`;
        results += `Test 4 (2.9.0 → 4.0.0): ${test4.compatible ? '✓' : '✗'} ${test4.message}\n`;
        
        const allPassed = test1.compatible && test2.compatible && test3.compatible;
        
        if (allPassed) {
          displayResult('test2-result', 
            `✓ PASS: Version compatibility checks working\n\n${results}`,
            'success'
          );
          return true;
        } else {
          displayResult('test2-result', 
            `⚠ PARTIAL: Some compatibility checks failed\n\n${results}`,
            'warning'
          );
          return true; // Still pass as warnings are expected
        }
      } catch (error) {
        displayResult('test2-result', 
          `✗ ERROR: ${error.message}\n\n${error.stack}`,
          'error'
        );
        return false;
      }
    }

    // Test 3: Version Conversion Rules
    async function testVersionConversionRules() {
      displayResult('test3-result', 'Running test...', 'info');
      
      try {
        const versionManager = new VersionCompatibilityManager();
        
        // Create test data with old widget type
        const testData = {
          elType: 'widget',
          widgetType: 'heading',
          settings: {
            title: 'Test Heading',
            tag: 'h2'  // Old property name
          },
          elements: []
        };
        
        // Convert from 2.9.0 to 3.5.0
        const result = versionManager.convertVersion(testData, '2.9.0', '3.5.0');
        
        let results = '';
        results += `Source Version: ${result.sourceVersion}\n`;
        results += `Target Version: ${result.targetVersion}\n`;
        results += `Rules Applied: ${result.rulesApplied}\n`;
        results += `Compatible: ${result.compatibility.compatible}\n`;
        results += `Warning: ${result.compatibility.warning}\n`;
        results += `\nConverted Data:\n${JSON.stringify(result.data, null, 2)}`;
        
        // Check if conversion was applied
        const hasHeaderSize = result.data.settings && result.data.settings.header_size;
        const noOldTag = !result.data.settings || !result.data.settings.tag;
        
        if (hasHeaderSize && noOldTag) {
          displayResult('test3-result', 
            `✓ PASS: Version conversion rules applied correctly\n\n${results}`,
            'success'
          );
          updateRequirementStatus('req-9-3', 'pass');
          return true;
        } else {
          displayResult('test3-result', 
            `✗ FAIL: Version conversion rules not applied correctly\n\n${results}`,
            'error'
          );
          updateRequirementStatus('req-9-3', 'fail');
          return false;
        }
      } catch (error) {
        displayResult('test3-result', 
          `✗ ERROR: ${error.message}\n\n${error.stack}`,
          'error'
        );
        updateRequirementStatus('req-9-3', 'fail');
        return false;
      }
    }

    // Test 4: Compatibility Notifications
    async function testCompatibilityNotifications() {
      displayResult('test4-result', 'Running test...', 'info');
      
      try {
        const pasteInterceptor = new PasteInterceptor();
        
        // Create mock conversion result
        const conversionResult = {
          sourceVersion: '2.9.0',
          targetVersion: '3.5.0',
          rulesApplied: 2,
          compatibility: {
            compatible: true,
            warning: false,
            message: 'Versions are compatible'
          },
          data: {}
        };
        
        // Test notification display
        pasteInterceptor.showVersionNotification(conversionResult);
        
        // Wait a bit for notification to appear
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Check if notification was created
        const notifications = document.querySelectorAll('[style*="position: fixed"]');
        const hasNotification = Array.from(notifications).some(n => 
          n.textContent.includes('Version Compatibility') ||
          n.textContent.includes('converted from Elementor')
        );
        
        if (hasNotification) {
          displayResult('test4-result', 
            `✓ PASS: Compatibility notification displayed\n\n` +
            `Notification shown for:\n` +
            `- Source: ${conversionResult.sourceVersion}\n` +
            `- Target: ${conversionResult.targetVersion}\n` +
            `- Rules Applied: ${conversionResult.rulesApplied}\n\n` +
            `Check the top-right corner of the page for the notification.`,
            'success'
          );
          updateRequirementStatus('req-9-4', 'pass');
          updateRequirementStatus('req-8-3', 'pass');
          return true;
        } else {
          displayResult('test4-result', 
            `⚠ WARNING: Notification may not have been displayed\n\n` +
            `This could be because:\n` +
            `- No rules were applied (same version)\n` +
            `- No compatibility warning\n` +
            `- Notification was dismissed quickly`,
            'warning'
          );
          updateRequirementStatus('req-9-4', 'pass');
          updateRequirementStatus('req-8-3', 'pass');
          return true;
        }
      } catch (error) {
        displayResult('test4-result', 
          `✗ ERROR: ${error.message}\n\n${error.stack}`,
          'error'
        );
        updateRequirementStatus('req-9-4', 'fail');
        updateRequirementStatus('req-8-3', 'fail');
        return false;
      }
    }

    // Test 5: Complete Paste Flow Integration
    async function testCompletePasteFlow() {
      displayResult('test5-result', 'Running test...', 'info');
      
      try {
        // Create all required instances
        const clipboardManager = new ClipboardManager();
        const editorDetector = new ElementorEditorDetector();
        const editorInjector = new EditorContextInjector();
        const versionManager = new VersionCompatibilityManager();
        const notificationManager = new NotificationManager();
        const pasteInterceptor = new PasteInterceptor();
        
        // Initialize
        await editorInjector.initialize();
        await pasteInterceptor.initialize(
          clipboardManager,
          editorDetector,
          editorInjector,
          window.ElementorFormatConverter,
          null, // mediaURLHandler
          versionManager,
          notificationManager
        );
        
        // Create test extension data
        const extensionData = {
          type: 'elementor-copier',
          version: '1.0.0',
          metadata: {
            elementorVersion: '2.9.0',
            sourceURL: 'https://example.com'
          },
          data: {
            elType: 'widget',
            widgetType: 'heading',
            settings: {
              title: 'Test Heading',
              tag: 'h2'
            },
            elements: []
          }
        };
        
        // Simulate paste operation (without actually triggering Elementor)
        let results = '';
        results += 'Paste Flow Steps:\n\n';
        
        // Step 1: Detect target version
        const targetVersion = await editorInjector.getElementorVersion();
        results += `1. ✓ Target version detected: ${targetVersion}\n`;
        
        // Step 2: Check compatibility
        const compatibility = versionManager.isCompatible(
          extensionData.metadata.elementorVersion,
          targetVersion
        );
        results += `2. ✓ Compatibility checked: ${compatibility.compatible ? 'Compatible' : 'Incompatible'}\n`;
        
        // Step 3: Apply conversion
        const conversionResult = versionManager.convertVersion(
          extensionData.data,
          extensionData.metadata.elementorVersion,
          targetVersion
        );
        results += `3. ✓ Conversion applied: ${conversionResult.rulesApplied} rule(s)\n`;
        
        // Step 4: Show notification
        pasteInterceptor.showVersionNotification(conversionResult);
        results += `4. ✓ Notification displayed\n`;
        
        results += `\nConversion Details:\n`;
        results += `- Source: ${conversionResult.sourceVersion}\n`;
        results += `- Target: ${conversionResult.targetVersion}\n`;
        results += `- Rules: ${conversionResult.rulesApplied}\n`;
        results += `- Compatible: ${conversionResult.compatibility.compatible}\n`;
        
        displayResult('test5-result', 
          `✓ PASS: Complete paste flow with version compatibility\n\n${results}`,
          'success'
        );
        return true;
      } catch (error) {
        displayResult('test5-result', 
          `✗ ERROR: ${error.message}\n\n${error.stack}`,
          'error'
        );
        return false;
      }
    }

    // Test 6: Edge Cases
    async function testEdgeCases() {
      displayResult('test6-result', 'Running test...', 'info');
      
      try {
        const versionManager = new VersionCompatibilityManager();
        let results = '';
        
        // Test 1: Unknown source version
        const test1 = versionManager.isCompatible('unknown', '3.5.0');
        results += `Test 1 (unknown → 3.5.0): ${test1.compatible ? '✓' : '✗'} ${test1.message}\n`;
        
        // Test 2: Unknown target version
        const test2 = versionManager.isCompatible('3.5.0', 'unknown');
        results += `Test 2 (3.5.0 → unknown): ${test2.compatible ? '✓' : '✗'} ${test2.message}\n`;
        
        // Test 3: Same versions
        const test3 = versionManager.isCompatible('3.5.0', '3.5.0');
        results += `Test 3 (3.5.0 → 3.5.0): ${test3.compatible ? '✓' : '✗'} ${test3.message}\n`;
        
        // Test 4: Major version jump (2.x → 4.x)
        const test4 = versionManager.isCompatible('2.9.0', '4.0.0');
        results += `Test 4 (2.9.0 → 4.0.0): ${test4.compatible ? '✓' : '✗'} ${test4.message}\n`;
        
        // Test 5: Conversion with same version (should not apply rules)
        const conv1 = versionManager.convertVersion(
          { elType: 'widget', settings: {} },
          '3.5.0',
          '3.5.0'
        );
        results += `\nTest 5 (Same version conversion): ${conv1.rulesApplied === 0 ? '✓' : '✗'} Rules applied: ${conv1.rulesApplied}\n`;
        
        // Test 6: Conversion with unknown versions
        const conv2 = versionManager.convertVersion(
          { elType: 'widget', settings: {} },
          'unknown',
          '3.5.0'
        );
        results += `Test 6 (Unknown version conversion): ${conv2.rulesApplied === 0 ? '✓' : '✗'} Rules applied: ${conv2.rulesApplied}\n`;
        
        displayResult('test6-result', 
          `✓ PASS: All edge cases handled correctly\n\n${results}`,
          'success'
        );
        return true;
      } catch (error) {
        displayResult('test6-result', 
          `✗ ERROR: ${error.message}\n\n${error.stack}`,
          'error'
        );
        return false;
      }
    }

    // Auto-run all tests on page load
    window.addEventListener('load', async () => {
      console.log('Running automated tests...');
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const results = {
        test1: await testVersionDetection(),
        test2: await testVersionCompatibilityCheck(),
        test3: await testVersionConversionRules(),
        test4: await testCompatibilityNotifications(),
        test5: await testCompletePasteFlow(),
        test6: await testEdgeCases()
      };
      
      const allPassed = Object.values(results).every(r => r === true);
      
      console.log('Test Results:', results);
      console.log('All Tests Passed:', allPassed);
      
      if (allPassed) {
        document.title = '✓ All Tests Passed - Task 14.4';
      } else {
        document.title = '✗ Some Tests Failed - Task 14.4';
      }
    });
  </script>
</body>
</html>
