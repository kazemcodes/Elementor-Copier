<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Sanitizer Test Suite</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #92003b;
      padding-bottom: 10px;
    }
    h2 {
      color: #555;
      margin-top: 30px;
      border-left: 4px solid #92003b;
      padding-left: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-case {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .test-case h3 {
      margin-top: 0;
      color: #666;
      font-size: 16px;
    }
    .pass {
      color: #28a745;
      font-weight: bold;
    }
    .fail {
      color: #dc3545;
      font-weight: bold;
    }
    .warning {
      color: #ffc107;
      font-weight: bold;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .result.pass {
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .result.fail {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    button {
      background: #92003b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #750030;
    }
    #summary {
      background: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>üõ°Ô∏è Content Sanitizer Test Suite</h1>
  
  <div id="summary">
    <strong>Test Summary:</strong> <span id="summary-text">Click "Run All Tests" to begin</span>
  </div>

  <button onclick="runAllTests()">Run All Tests</button>
  <button onclick="clearResults()">Clear Results</button>

  <div id="test-results"></div>

  <script src="content-sanitizer.js"></script>
  <script>
    const sanitizer = new ContentSanitizer();
    let totalTests = 0;
    let passedTests = 0;
    let failedTests = 0;

    function clearResults() {
      document.getElementById('test-results').innerHTML = '';
      totalTests = 0;
      passedTests = 0;
      failedTests = 0;
      updateSummary();
    }

    function updateSummary() {
      const summaryText = document.getElementById('summary-text');
      if (totalTests === 0) {
        summaryText.textContent = 'Click "Run All Tests" to begin';
      } else {
        summaryText.innerHTML = `
          <span class="pass">${passedTests} passed</span> / 
          <span class="fail">${failedTests} failed</span> / 
          ${totalTests} total
        `;
      }
    }

    function addTestResult(sectionTitle, testName, passed, details) {
      totalTests++;
      if (passed) {
        passedTests++;
      } else {
        failedTests++;
      }

      let section = document.querySelector(`[data-section="${sectionTitle}"]`);
      if (!section) {
        section = document.createElement('div');
        section.className = 'test-section';
        section.setAttribute('data-section', sectionTitle);
        section.innerHTML = `<h2>${sectionTitle}</h2>`;
        document.getElementById('test-results').appendChild(section);
      }

      const testCase = document.createElement('div');
      testCase.className = 'test-case';
      testCase.innerHTML = `
        <h3>${testName}</h3>
        <div class="result ${passed ? 'pass' : 'fail'}">
          <strong>${passed ? '‚úì PASS' : '‚úó FAIL'}</strong>
          ${details ? `<pre>${details}</pre>` : ''}
        </div>
      `;
      section.appendChild(testCase);

      updateSummary();
    }

    // Test 1: HTML Sanitization
    function testHTMLSanitization() {
      const tests = [
        {
          name: 'Remove script tags',
          input: '<div>Hello<script>alert("xss")</script>World</div>',
          shouldNotContain: '<script'
        },
        {
          name: 'Remove iframe tags',
          input: '<div>Content<iframe src="evil.com"></iframe></div>',
          shouldNotContain: '<iframe'
        },
        {
          name: 'Remove event handlers',
          input: '<button onclick="alert(1)">Click</button>',
          shouldNotContain: 'onclick'
        },
        {
          name: 'Remove multiple dangerous elements',
          input: '<div><script>bad()</script><iframe></iframe><object></object></div>',
          shouldNotContain: ['<script', '<iframe', '<object']
        },
        {
          name: 'Preserve safe HTML',
          input: '<div class="safe"><p>Hello <strong>World</strong></p></div>',
          shouldContain: ['<div', '<p>', '<strong>']
        }
      ];

      tests.forEach(test => {
        const result = sanitizer.sanitizeHTML(test.input);
        let passed = true;
        let details = `Input: ${test.input}\nOutput: ${result}`;

        if (test.shouldNotContain) {
          const patterns = Array.isArray(test.shouldNotContain) ? test.shouldNotContain : [test.shouldNotContain];
          patterns.forEach(pattern => {
            if (result.includes(pattern)) {
              passed = false;
              details += `\n‚ùå Still contains: ${pattern}`;
            }
          });
        }

        if (test.shouldContain) {
          test.shouldContain.forEach(pattern => {
            if (!result.includes(pattern)) {
              passed = false;
              details += `\n‚ùå Missing: ${pattern}`;
            }
          });
        }

        addTestResult('HTML Sanitization', test.name, passed, details);
      });
    }

    // Test 2: URL Sanitization
    function testURLSanitization() {
      const tests = [
        {
          name: 'Block javascript: URLs',
          input: 'javascript:alert(1)',
          expected: ''
        },
        {
          name: 'Block data: URLs',
          input: 'data:text/html,<script>alert(1)</script>',
          expected: ''
        },
        {
          name: 'Allow HTTP URLs',
          input: 'https://example.com/image.jpg',
          expected: 'https://example.com/image.jpg'
        },
        {
          name: 'Allow relative URLs',
          input: '/images/photo.jpg',
          expected: '/images/photo.jpg'
        },
        {
          name: 'Block encoded javascript:',
          input: 'java%73cript:alert(1)',
          expected: ''
        },
        {
          name: 'Allow anchor links',
          input: '#section-1',
          expected: '#section-1'
        }
      ];

      tests.forEach(test => {
        const result = sanitizer.sanitizeURL(test.input);
        const passed = result === test.expected;
        const details = `Input: ${test.input}\nExpected: ${test.expected}\nGot: ${result}`;
        addTestResult('URL Sanitization', test.name, passed, details);
      });
    }

    // Test 3: CSS Sanitization
    function testCSSSanitization() {
      const tests = [
        {
          name: 'Remove javascript: in CSS',
          input: 'background: url(javascript:alert(1))',
          shouldNotContain: 'javascript:'
        },
        {
          name: 'Remove expression()',
          input: 'width: expression(alert(1))',
          shouldNotContain: 'expression'
        },
        {
          name: 'Remove @import',
          input: '@import url(evil.css); color: red;',
          shouldNotContain: '@import'
        },
        {
          name: 'Preserve safe CSS',
          input: 'color: red; font-size: 16px;',
          shouldContain: ['color: red', 'font-size: 16px']
        }
      ];

      tests.forEach(test => {
        const result = sanitizer.sanitizeCSS(test.input);
        let passed = true;
        let details = `Input: ${test.input}\nOutput: ${result}`;

        if (test.shouldNotContain) {
          if (result.toLowerCase().includes(test.shouldNotContain.toLowerCase())) {
            passed = false;
            details += `\n‚ùå Still contains: ${test.shouldNotContain}`;
          }
        }

        if (test.shouldContain) {
          test.shouldContain.forEach(pattern => {
            if (!result.includes(pattern)) {
              passed = false;
              details += `\n‚ùå Missing: ${pattern}`;
            }
          });
        }

        addTestResult('CSS Sanitization', test.name, passed, details);
      });
    }

    // Test 4: Settings Validation
    function testSettingsValidation() {
      const tests = [
        {
          name: 'Validate string settings',
          input: { title: 'Hello World', text: 'Content' },
          widgetType: 'heading',
          shouldPass: true
        },
        {
          name: 'Sanitize HTML in string settings',
          input: { title: '<script>alert(1)</script>Hello' },
          widgetType: 'heading',
          shouldNotContain: '<script'
        },
        {
          name: 'Validate URL settings',
          input: { url: 'javascript:alert(1)' },
          widgetType: 'button',
          expected: { url: '' }
        },
        {
          name: 'Preserve safe URLs',
          input: { url: 'https://example.com' },
          widgetType: 'button',
          expected: { url: 'https://example.com' }
        },
        {
          name: 'Validate nested objects',
          input: {
            image: {
              url: 'https://example.com/image.jpg',
              id: 123
            }
          },
          widgetType: 'image',
          shouldPass: true
        }
      ];

      tests.forEach(test => {
        const result = sanitizer.validateSettings(test.input, test.widgetType);
        let passed = true;
        let details = `Input: ${JSON.stringify(test.input, null, 2)}\nOutput: ${JSON.stringify(result, null, 2)}`;

        if (test.shouldNotContain) {
          const resultStr = JSON.stringify(result);
          if (resultStr.includes(test.shouldNotContain)) {
            passed = false;
            details += `\n‚ùå Still contains: ${test.shouldNotContain}`;
          }
        }

        if (test.expected) {
          if (JSON.stringify(result) !== JSON.stringify(test.expected)) {
            passed = false;
            details += `\n‚ùå Expected: ${JSON.stringify(test.expected)}`;
          }
        }

        addTestResult('Settings Validation', test.name, passed, details);
      });
    }

    // Test 5: Complete Element Sanitization
    function testElementSanitization() {
      const tests = [
        {
          name: 'Sanitize widget element',
          input: {
            elType: 'widget',
            widgetType: 'heading',
            id: 'abc12345',
            settings: {
              title: '<script>alert(1)</script>Hello',
              url: 'javascript:void(0)'
            },
            elements: [],
            isInner: false
          },
          shouldNotContain: ['<script', 'javascript:']
        },
        {
          name: 'Sanitize nested elements',
          input: {
            elType: 'section',
            id: 'def67890',
            settings: {},
            elements: [
              {
                elType: 'column',
                id: 'col12345',
                settings: {},
                elements: [
                  {
                    elType: 'widget',
                    widgetType: 'text-editor',
                    id: 'wid12345',
                    settings: {
                      content: '<iframe src="evil.com"></iframe>Safe content'
                    },
                    elements: [],
                    isInner: false
                  }
                ],
                isInner: false
              }
            ],
            isInner: false
          },
          shouldNotContain: '<iframe'
        },
        {
          name: 'Preserve element structure',
          input: {
            elType: 'widget',
            widgetType: 'button',
            id: 'btn12345',
            settings: {
              text: 'Click Me',
              url: 'https://example.com'
            },
            elements: [],
            isInner: false
          },
          shouldContain: ['elType', 'widgetType', 'settings', 'elements']
        }
      ];

      tests.forEach(test => {
        const result = sanitizer.sanitizeElementData(test.input);
        let passed = true;
        let details = `Input: ${JSON.stringify(test.input, null, 2)}\nOutput: ${JSON.stringify(result, null, 2)}`;

        const resultStr = JSON.stringify(result);

        if (test.shouldNotContain) {
          const patterns = Array.isArray(test.shouldNotContain) ? test.shouldNotContain : [test.shouldNotContain];
          patterns.forEach(pattern => {
            if (resultStr.includes(pattern)) {
              passed = false;
              details += `\n‚ùå Still contains: ${pattern}`;
            }
          });
        }

        if (test.shouldContain) {
          test.shouldContain.forEach(pattern => {
            if (!resultStr.includes(pattern)) {
              passed = false;
              details += `\n‚ùå Missing: ${pattern}`;
            }
          });
        }

        if (!result) {
          passed = false;
          details += '\n‚ùå Sanitization returned null';
        }

        addTestResult('Element Sanitization', test.name, passed, details);
      });
    }

    // Test 6: Edge Cases
    function testEdgeCases() {
      const tests = [
        {
          name: 'Handle null input',
          test: () => {
            const result = sanitizer.sanitizeHTML(null);
            return result === '';
          }
        },
        {
          name: 'Handle undefined input',
          test: () => {
            const result = sanitizer.sanitizeURL(undefined);
            return result === '';
          }
        },
        {
          name: 'Handle empty string',
          test: () => {
            const result = sanitizer.sanitizeHTML('');
            return result === '';
          }
        },
        {
          name: 'Handle non-string HTML input',
          test: () => {
            const result = sanitizer.sanitizeHTML(123);
            return result === '';
          }
        },
        {
          name: 'Handle malformed HTML',
          test: () => {
            const result = sanitizer.sanitizeHTML('<div><p>Unclosed');
            return typeof result === 'string';
          }
        },
        {
          name: 'Handle deeply nested elements',
          test: () => {
            const deepElement = {
              elType: 'section',
              id: 'sec1',
              settings: {},
              elements: [
                {
                  elType: 'column',
                  id: 'col1',
                  settings: {},
                  elements: [
                    {
                      elType: 'widget',
                      widgetType: 'text',
                      id: 'wid1',
                      settings: { content: '<script>bad</script>Good' },
                      elements: [],
                      isInner: false
                    }
                  ],
                  isInner: false
                }
              ],
              isInner: false
            };
            const result = sanitizer.sanitizeElementData(deepElement);
            return result && !JSON.stringify(result).includes('<script');
          }
        }
      ];

      tests.forEach(test => {
        try {
          const passed = test.test();
          addTestResult('Edge Cases', test.name, passed, passed ? 'Test passed' : 'Test failed');
        } catch (error) {
          addTestResult('Edge Cases', test.name, false, `Error: ${error.message}`);
        }
      });
    }

    function runAllTests() {
      clearResults();
      console.log('Running Content Sanitizer Test Suite...');
      
      testHTMLSanitization();
      testURLSanitization();
      testCSSSanitization();
      testSettingsValidation();
      testElementSanitization();
      testEdgeCases();
      
      console.log(`Tests complete: ${passedTests}/${totalTests} passed`);
    }

    // Auto-run tests on load
    window.addEventListener('load', () => {
      console.log('Content Sanitizer Test Suite loaded');
    });
  </script>
</body>
</html>
