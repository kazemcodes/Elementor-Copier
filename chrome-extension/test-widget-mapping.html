<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Type Mapping Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-section h2 {
      margin-top: 0;
      color: #555;
    }
    .result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 3px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Widget Type Mapping Test Suite</h1>
  <p>This test suite verifies the widget type mapping functionality for version compatibility.</p>
  
  <button onclick="runAllTests()">Run All Tests</button>
  
  <div id="results"></div>

  <script src="elementor-format-converter.js"></script>
  <script>
    const { mapWidgetType, convertToNativeFormat } = window.ElementorFormatConverter;

    function logResult(testName, passed, message, details = null) {
      const resultsDiv = document.getElementById('results');
      const resultDiv = document.createElement('div');
      resultDiv.className = `result ${passed ? 'success' : 'error'}`;
      
      let html = `<strong>${passed ? '✓' : '✗'} ${testName}</strong><br>${message}`;
      if (details) {
        html += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
      }
      
      resultDiv.innerHTML = html;
      resultsDiv.appendChild(resultDiv);
      
      return passed;
    }

    function testDeprecatedWidgetFallback() {
      const result = mapWidgetType('wordpress', '3.0.0', '3.5.0');
      const passed = result === 'text-editor';
      logResult(
        'Deprecated Widget Fallback',
        passed,
        `Expected 'text-editor', got '${result}'`,
        { input: 'wordpress', output: result }
      );
      return passed;
    }

    function testVersion2to3Migration() {
      const result = mapWidgetType('image-box', '2.9.0', '3.5.0');
      const passed = result === 'icon-box';
      logResult(
        'Version 2.x → 3.x Migration',
        passed,
        `Expected 'icon-box', got '${result}'`,
        { input: 'image-box', sourceVersion: '2.9.0', targetVersion: '3.5.0', output: result }
      );
      return passed;
    }

    function testVersion2to4Migration() {
      const result = mapWidgetType('image-box', '2.9.0', '4.0.0');
      const passed = result === 'icon-box';
      logResult(
        'Version 2.x → 4.x Migration (Multi-step)',
        passed,
        `Expected 'icon-box', got '${result}'`,
        { input: 'image-box', sourceVersion: '2.9.0', targetVersion: '4.0.0', output: result }
      );
      return passed;
    }

    function testNoMigrationNeeded() {
      const result = mapWidgetType('heading', '3.5.0', '3.8.0');
      const passed = result === 'heading';
      logResult(
        'No Migration Needed (Same Major Version)',
        passed,
        `Expected 'heading', got '${result}'`,
        { input: 'heading', sourceVersion: '3.5.0', targetVersion: '3.8.0', output: result }
      );
      return passed;
    }

    function testSettingsMigration() {
      const testData = {
        data: {
          elType: 'widget',
          widgetType: 'heading',
          settings: {
            title: 'Test Heading',
            tag: 'h2',  // Old property name
            align: 'center'
          },
          elements: [],
          isInner: false
        },
        metadata: {
          elementorVersion: '2.9.0'
        }
      };

      try {
        const result = convertToNativeFormat(testData, { targetVersion: '3.5.0' });
        const passed = result.settings.header_size === 'h2' && !result.settings.tag;
        logResult(
          'Settings Property Migration (tag → header_size)',
          passed,
          passed ? 'Settings migrated correctly' : 'Settings migration failed',
          { 
            input: testData.data.settings,
            output: result.settings
          }
        );
        return passed;
      } catch (error) {
        logResult('Settings Property Migration', false, error.message);
        return false;
      }
    }

    function testMultipleDeprecatedWidgets() {
      const tests = [
        { input: 'wp-widget-text', expected: 'text-editor' },
        { input: 'wp-widget-media_image', expected: 'image' },
        { input: 'wp-widget-media_video', expected: 'video' },
        { input: 'wp-widget-media_audio', expected: 'audio' }
      ];

      let allPassed = true;
      const results = [];

      tests.forEach(test => {
        const result = mapWidgetType(test.input, '3.0.0', '3.5.0');
        const passed = result === test.expected;
        allPassed = allPassed && passed;
        results.push({ input: test.input, expected: test.expected, actual: result, passed });
      });

      logResult(
        'Multiple Deprecated Widgets',
        allPassed,
        allPassed ? 'All deprecated widgets mapped correctly' : 'Some mappings failed',
        results
      );
      return allPassed;
    }

    function testCompleteElementConversion() {
      const testData = {
        data: {
          elType: 'section',
          settings: {
            layout: 'boxed',
            gap: 'default'
          },
          elements: [
            {
              elType: 'column',
              settings: {
                _column_size: 50
              },
              elements: [
                {
                  elType: 'widget',
                  widgetType: 'image-box',  // Should be migrated to icon-box
                  settings: {
                    title: 'Test',
                    description: 'Description'
                  },
                  elements: [],
                  isInner: false
                }
              ],
              isInner: false
            }
          ],
          isInner: false
        },
        metadata: {
          elementorVersion: '2.9.0'
        }
      };

      try {
        const result = convertToNativeFormat(testData, { targetVersion: '3.5.0' });
        const widgetType = result.elements[0]?.elements[0]?.widgetType;
        const passed = widgetType === 'icon-box';
        
        logResult(
          'Complete Element Conversion with Nested Widget',
          passed,
          passed ? 'Nested widget type migrated correctly' : 'Widget type migration failed in nested structure',
          {
            inputWidgetType: 'image-box',
            outputWidgetType: widgetType,
            structure: 'section > column > widget'
          }
        );
        return passed;
      } catch (error) {
        logResult('Complete Element Conversion', false, error.message);
        return false;
      }
    }

    function testUnknownVersionHandling() {
      const result = mapWidgetType('heading', 'unknown', '3.5.0');
      const passed = result === 'heading';
      logResult(
        'Unknown Version Handling',
        passed,
        `Expected 'heading' (no migration), got '${result}'`,
        { input: 'heading', sourceVersion: 'unknown', targetVersion: '3.5.0', output: result }
      );
      return passed;
    }

    function runAllTests() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="info"><strong>Running tests...</strong></div>';

      const tests = [
        testDeprecatedWidgetFallback,
        testVersion2to3Migration,
        testVersion2to4Migration,
        testNoMigrationNeeded,
        testSettingsMigration,
        testMultipleDeprecatedWidgets,
        testCompleteElementConversion,
        testUnknownVersionHandling
      ];

      let passed = 0;
      let failed = 0;

      tests.forEach(test => {
        if (test()) {
          passed++;
        } else {
          failed++;
        }
      });

      const summaryDiv = document.createElement('div');
      summaryDiv.className = `result ${failed === 0 ? 'success' : 'error'}`;
      summaryDiv.innerHTML = `
        <strong>Test Summary</strong><br>
        Total: ${tests.length}<br>
        Passed: ${passed}<br>
        Failed: ${failed}
      `;
      resultsDiv.insertBefore(summaryDiv, resultsDiv.firstChild);
    }

    // Run tests on page load
    window.addEventListener('load', () => {
      console.log('Widget Type Mapping Test Suite loaded');
    });
  </script>
</body>
</html>
