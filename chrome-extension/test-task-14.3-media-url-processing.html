<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task 14.3: Media URL Processing Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #2196f3;
      padding-bottom: 10px;
    }
    h2 {
      color: #2196f3;
      margin-top: 0;
    }
    .test-case {
      margin: 15px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #2196f3;
    }
    .test-case h3 {
      margin-top: 0;
      color: #333;
      font-size: 16px;
    }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #1976d2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .result.success {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      color: #2e7d32;
    }
    .result.error {
      background: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
    }
    .result.info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      color: #1565c0;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.pass {
      background: #4caf50;
      color: white;
    }
    .status.fail {
      background: #f44336;
      color: white;
    }
    .status.pending {
      background: #ff9800;
      color: white;
    }
    pre {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .info-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .info-box strong {
      color: #856404;
    }
  </style>
</head>
<body>
  <h1>Task 14.3: Media URL Processing in Paste Flow</h1>
  
  <div class="info-box">
    <strong>Test Objective:</strong> Verify that media URL processing is properly integrated into the paste flow,
    including extraction, conversion to absolute URLs, and notification display for external media.
  </div>

  <div class="test-section">
    <h2>Test Setup</h2>
    <div class="test-case">
      <h3>1. Load Required Modules</h3>
      <button onclick="loadModules()">Load Modules</button>
      <div id="load-result"></div>
    </div>
  </div>

  <div class="test-section">
    <h2>Media URL Processing Tests</h2>
    
    <div class="test-case">
      <h3>Test 1: Extract Media URLs from Element Data</h3>
      <p>Test that media URLs are correctly extracted from element data structure.</p>
      <button onclick="testExtractMediaURLs()">Run Test</button>
      <div id="test1-result"></div>
    </div>

    <div class="test-case">
      <h3>Test 2: Convert to Absolute URLs</h3>
      <p>Test that relative URLs are converted to absolute URLs with correct origin.</p>
      <button onclick="testConvertToAbsoluteURLs()">Run Test</button>
      <div id="test2-result"></div>
    </div>

    <div class="test-case">
      <h3>Test 3: Update Element Data with Absolute URLs</h3>
      <p>Test that element data is updated with absolute URLs in place.</p>
      <button onclick="testUpdateElementURLs()">Run Test</button>
      <div id="test3-result"></div>
    </div>

    <div class="test-case">
      <h3>Test 4: Show Media Notification (Notification Manager)</h3>
      <p>Test that external media notification is displayed using NotificationManager.</p>
      <button onclick="testShowMediaNotificationWithManager()">Run Test</button>
      <div id="test4-result"></div>
    </div>

    <div class="test-case">
      <h3>Test 5: Show Media Notification (Fallback)</h3>
      <p>Test that external media notification is displayed using fallback method.</p>
      <button onclick="testShowMediaNotificationFallback()">Run Test</button>
      <div id="test5-result"></div>
    </div>

    <div class="test-case">
      <h3>Test 6: Integration Test - Complete Paste Flow</h3>
      <p>Test the complete paste flow with media URL processing integrated.</p>
      <button onclick="testCompletePasteFlow()">Run Test</button>
      <div id="test6-result"></div>
    </div>
  </div>

  <div class="test-section">
    <h2>Test Summary</h2>
    <div id="summary"></div>
  </div>

  <script src="media-url-handler.js"></script>
  <script src="notification-manager.js"></script>
  <script src="paste-interceptor.js"></script>

  <script>
    let mediaURLHandler;
    let notificationManager;
    let pasteInterceptor;
    let testResults = [];

    function loadModules() {
      const resultDiv = document.getElementById('load-result');
      try {
        mediaURLHandler = new MediaURLHandler();
        notificationManager = new NotificationManager();
        pasteInterceptor = new PasteInterceptor();
        
        resultDiv.innerHTML = '<div class="result success">✓ All modules loaded successfully</div>';
        return true;
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">✗ Failed to load modules: ${error.message}</div>`;
        return false;
      }
    }

    function testExtractMediaURLs() {
      const resultDiv = document.getElementById('test1-result');
      
      try {
        // Test data with various media URLs
        const elementData = {
          elType: 'widget',
          widgetType: 'image',
          settings: {
            image: {
              url: 'https://example.com/image.jpg'
            },
            background_image: {
              url: '/wp-content/uploads/bg.png'
            }
          },
          elements: [
            {
              elType: 'widget',
              widgetType: 'video',
              settings: {
                video_link: 'https://example.com/video.mp4'
              }
            }
          ]
        };

        const mediaURLs = mediaURLHandler.extractMediaURLs(elementData);
        
        const expected = 3; // image.url, background_image.url, video_link
        const actual = mediaURLs.length;
        
        if (actual === expected) {
          resultDiv.innerHTML = `
            <div class="result success">
              ✓ Test Passed
              <br>Expected: ${expected} URLs
              <br>Found: ${actual} URLs
              <br><br>Extracted URLs:
              <pre>${JSON.stringify(mediaURLs, null, 2)}</pre>
            </div>
          `;
          testResults.push({ name: 'Extract Media URLs', passed: true });
        } else {
          throw new Error(`Expected ${expected} URLs, found ${actual}`);
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">✗ Test Failed: ${error.message}</div>`;
        testResults.push({ name: 'Extract Media URLs', passed: false });
      }
      
      updateSummary();
    }

    function testConvertToAbsoluteURLs() {
      const resultDiv = document.getElementById('test2-result');
      
      try {
        const mediaURLs = [
          { path: 'settings.image.url', url: '/wp-content/uploads/image.jpg', type: 'image' },
          { path: 'settings.background_image.url', url: '//cdn.example.com/bg.png', type: 'image' },
          { path: 'settings.video_link', url: 'https://example.com/video.mp4', type: 'video' }
        ];

        const sourceOrigin = 'https://source-site.com';
        const absoluteURLs = mediaURLHandler.convertToAbsoluteURLs(mediaURLs, sourceOrigin);
        
        // Check that all URLs are absolute
        const allAbsolute = absoluteURLs.every(item => {
          return item.url.startsWith('http://') || item.url.startsWith('https://');
        });
        
        // Check that relative URL was converted correctly
        const relativeConverted = absoluteURLs[0].url === 'https://source-site.com/wp-content/uploads/image.jpg';
        
        // Check that protocol-relative URL was converted
        const protocolRelativeConverted = absoluteURLs[1].url === 'https://cdn.example.com/bg.png';
        
        // Check external flag
        const externalFlagged = absoluteURLs.some(item => item.isExternal);
        
        if (allAbsolute && relativeConverted && protocolRelativeConverted && externalFlagged) {
          resultDiv.innerHTML = `
            <div class="result success">
              ✓ Test Passed
              <br>All URLs converted to absolute format
              <br>External URLs flagged correctly
              <br><br>Converted URLs:
              <pre>${JSON.stringify(absoluteURLs, null, 2)}</pre>
            </div>
          `;
          testResults.push({ name: 'Convert to Absolute URLs', passed: true });
        } else {
          throw new Error('URL conversion failed validation');
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">✗ Test Failed: ${error.message}</div>`;
        testResults.push({ name: 'Convert to Absolute URLs', passed: false });
      }
      
      updateSummary();
    }

    function testUpdateElementURLs() {
      const resultDiv = document.getElementById('test3-result');
      
      try {
        const elementData = {
          elType: 'widget',
          widgetType: 'image',
          settings: {
            image: {
              url: '/wp-content/uploads/image.jpg'
            }
          }
        };

        const sourceOrigin = 'https://source-site.com';
        const updatedData = mediaURLHandler.updateElementURLs(elementData, sourceOrigin);
        
        const expectedURL = 'https://source-site.com/wp-content/uploads/image.jpg';
        const actualURL = updatedData.settings.image.url;
        
        if (actualURL === expectedURL) {
          resultDiv.innerHTML = `
            <div class="result success">
              ✓ Test Passed
              <br>Element data updated with absolute URLs
              <br>Original: /wp-content/uploads/image.jpg
              <br>Updated: ${actualURL}
              <br><br>Updated Data:
              <pre>${JSON.stringify(updatedData, null, 2)}</pre>
            </div>
          `;
          testResults.push({ name: 'Update Element URLs', passed: true });
        } else {
          throw new Error(`Expected ${expectedURL}, got ${actualURL}`);
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">✗ Test Failed: ${error.message}</div>`;
        testResults.push({ name: 'Update Element URLs', passed: false });
      }
      
      updateSummary();
    }

    function testShowMediaNotificationWithManager() {
      const resultDiv = document.getElementById('test4-result');
      
      try {
        // Initialize paste interceptor with notification manager
        pasteInterceptor.notificationManager = notificationManager;
        
        const mediaURLs = [
          { 
            url: 'https://external-site.com/image1.jpg', 
            isExternal: true,
            type: 'image'
          },
          { 
            url: 'https://external-site.com/image2.jpg', 
            isExternal: true,
            type: 'image'
          }
        ];

        pasteInterceptor.showMediaNotification(mediaURLs);
        
        // Check if notification was created
        setTimeout(() => {
          const notifications = document.querySelectorAll('.ec-notification');
          if (notifications.length > 0) {
            resultDiv.innerHTML = `
              <div class="result success">
                ✓ Test Passed
                <br>Media notification displayed using NotificationManager
                <br>External URLs: ${mediaURLs.length}
                <br><br>Check the notification in the top-right corner
              </div>
            `;
            testResults.push({ name: 'Show Media Notification (Manager)', passed: true });
          } else {
            throw new Error('Notification not created');
          }
          updateSummary();
        }, 100);
        
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">✗ Test Failed: ${error.message}</div>`;
        testResults.push({ name: 'Show Media Notification (Manager)', passed: false });
        updateSummary();
      }
    }

    function testShowMediaNotificationFallback() {
      const resultDiv = document.getElementById('test5-result');
      
      try {
        // Initialize paste interceptor without notification manager
        pasteInterceptor.notificationManager = null;
        
        const mediaURLs = [
          { 
            url: 'https://external-site.com/video.mp4', 
            isExternal: true,
            type: 'video'
          }
        ];

        pasteInterceptor.showMediaNotification(mediaURLs);
        
        // Check if fallback notification was created
        setTimeout(() => {
          // Look for the fallback notification (not using ec-notification class)
          const allDivs = document.querySelectorAll('div');
          let foundFallback = false;
          
          allDivs.forEach(div => {
            if (div.textContent.includes('External Media Detected')) {
              foundFallback = true;
            }
          });
          
          if (foundFallback) {
            resultDiv.innerHTML = `
              <div class="result success">
                ✓ Test Passed
                <br>Fallback media notification displayed
                <br>External URLs: ${mediaURLs.length}
                <br><br>Check the notification in the top-right corner
              </div>
            `;
            testResults.push({ name: 'Show Media Notification (Fallback)', passed: true });
          } else {
            throw new Error('Fallback notification not created');
          }
          updateSummary();
        }, 100);
        
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">✗ Test Failed: ${error.message}</div>`;
        testResults.push({ name: 'Show Media Notification (Fallback)', passed: false });
        updateSummary();
      }
    }

    function testCompletePasteFlow() {
      const resultDiv = document.getElementById('test6-result');
      
      try {
        // Mock extension data with media URLs
        const extensionData = {
          data: {
            elType: 'widget',
            widgetType: 'image',
            settings: {
              image: {
                url: '/wp-content/uploads/test-image.jpg'
              },
              background_image: {
                url: 'https://external-site.com/bg.png'
              }
            }
          },
          metadata: {
            sourceURL: 'https://source-site.com/page',
            elementorVersion: '3.5.0'
          }
        };

        // Initialize paste interceptor with dependencies
        pasteInterceptor.mediaURLHandler = mediaURLHandler;
        pasteInterceptor.notificationManager = notificationManager;
        
        // Extract media URLs
        const mediaURLs = mediaURLHandler.extractMediaURLs(extensionData.data);
        
        // Get source origin
        const sourceOrigin = new URL(extensionData.metadata.sourceURL).origin;
        
        // Convert to absolute URLs
        const absoluteURLs = mediaURLHandler.convertToAbsoluteURLs(mediaURLs, sourceOrigin);
        
        // Update element data
        const updatedData = mediaURLHandler.updateElementURLs(extensionData.data, sourceOrigin);
        
        // Show notification
        pasteInterceptor.showMediaNotification(absoluteURLs);
        
        // Verify results
        const hasAbsoluteURLs = updatedData.settings.image.url.startsWith('https://');
        const hasExternalURLs = absoluteURLs.some(item => item.isExternal);
        
        if (hasAbsoluteURLs && hasExternalURLs) {
          resultDiv.innerHTML = `
            <div class="result success">
              ✓ Test Passed
              <br>Complete paste flow with media URL processing works correctly
              <br><br>Steps completed:
              <br>1. ✓ Extracted ${mediaURLs.length} media URLs
              <br>2. ✓ Converted to absolute URLs
              <br>3. ✓ Updated element data
              <br>4. ✓ Displayed notification for external media
              <br><br>Updated Element Data:
              <pre>${JSON.stringify(updatedData, null, 2)}</pre>
            </div>
          `;
          testResults.push({ name: 'Complete Paste Flow Integration', passed: true });
        } else {
          throw new Error('Integration test validation failed');
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">✗ Test Failed: ${error.message}</div>`;
        testResults.push({ name: 'Complete Paste Flow Integration', passed: false });
      }
      
      updateSummary();
    }

    function updateSummary() {
      const summaryDiv = document.getElementById('summary');
      const total = testResults.length;
      const passed = testResults.filter(r => r.passed).length;
      const failed = total - passed;
      
      let html = `
        <div style="font-size: 18px; margin-bottom: 15px;">
          <strong>Tests Run:</strong> ${total} | 
          <span style="color: #4caf50;"><strong>Passed:</strong> ${passed}</span> | 
          <span style="color: #f44336;"><strong>Failed:</strong> ${failed}</span>
        </div>
        <div style="margin-top: 15px;">
      `;
      
      testResults.forEach(result => {
        const statusClass = result.passed ? 'pass' : 'fail';
        const statusText = result.passed ? 'PASS' : 'FAIL';
        html += `
          <div style="margin: 5px 0;">
            ${result.name} <span class="status ${statusClass}">${statusText}</span>
          </div>
        `;
      });
      
      html += '</div>';
      summaryDiv.innerHTML = html;
    }

    // Auto-load modules on page load
    window.addEventListener('load', () => {
      loadModules();
    });
  </script>
</body>
</html>
