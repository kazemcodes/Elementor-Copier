<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paste Issue Diagnostic Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }

        .section h2 {
            margin-top: 0;
            color: #2196f3;
            font-size: 18px;
        }

        .check-item {
            padding: 12px;
            margin: 8px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.pass {
            background: #4caf50;
            color: white;
        }

        .status.fail {
            background: #f44336;
            color: white;
        }

        .status.warning {
            background: #ff9800;
            color: white;
        }

        .status.info {
            background: #2196f3;
            color: white;
        }

        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #1976d2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .log-entry {
            margin: 4px 0;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #858585;
            margin-right: 10px;
        }

        .log-error {
            color: #f48771;
        }

        .log-success {
            color: #89d185;
        }

        .log-info {
            color: #75beff;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            margin-top: 0;
            color: #856404;
        }

        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Paste Issue Diagnostic Tool</h1>
        <p class="subtitle">This tool helps diagnose why paste is not working in your WordPress site</p>

        <div class="instructions">
            <h3>üìã How to Use This Tool</h3>
            <ol>
                <li>Open this page in the same browser where you're having paste issues</li>
                <li>Click "Run Full Diagnostic" to check all components</li>
                <li>Review the results to identify what's not working</li>
                <li>Follow the suggested fixes for any failed checks</li>
                <li>If issues persist, copy the diagnostic log and report it</li>
            </ol>
        </div>

        <div style="margin-bottom: 20px;">
            <button onclick="runFullDiagnostic()">Run Full Diagnostic</button>
            <button onclick="testClipboard()">Test Clipboard Only</button>
            <button onclick="testModules()">Test Module Loading</button>
            <button onclick="clearLog()">Clear Log</button>
            <button onclick="exportLog()">Export Log</button>
        </div>

        <div class="section">
            <h2>1. Extension Status</h2>
            <div id="extension-status">
                <div class="check-item">Click "Run Full Diagnostic" to start...</div>
            </div>
        </div>

        <div class="section">
            <h2>2. Module Loading</h2>
            <div id="module-status">
                <div class="check-item">Waiting for diagnostic...</div>
            </div>
        </div>

        <div class="section">
            <h2>3. Clipboard Access</h2>
            <div id="clipboard-status">
                <div class="check-item">Waiting for diagnostic...</div>
            </div>
        </div>

        <div class="section">
            <h2>4. Elementor Detection</h2>
            <div id="elementor-status">
                <div class="check-item">Waiting for diagnostic...</div>
            </div>
        </div>

        <div class="section">
            <h2>5. Paste Interceptor</h2>
            <div id="paste-status">
                <div class="check-item">Waiting for diagnostic...</div>
            </div>
        </div>

        <div class="section">
            <h2>Diagnostic Log</h2>
            <div class="log" id="diagnostic-log"></div>
        </div>

        <div class="section">
            <h2>Common Issues & Fixes</h2>
            <div id="fixes"></div>
        </div>
    </div>

    <script>
        const diagnosticLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, type };
            diagnosticLog.push(entry);

            const logDiv = document.getElementById('diagnostic-log');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            let className = 'log-info';
            if (type === 'error') className = 'log-error';
            if (type === 'success') className = 'log-success';

            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span><span class="${className}">${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            diagnosticLog.length = 0;
            document.getElementById('diagnostic-log').innerHTML = '';
            log('Log cleared');
        }

        function exportLog() {
            const logText = diagnosticLog.map(e => `[${e.timestamp}] ${e.type.toUpperCase()}: ${e.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `paste-diagnostic-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('Log exported', 'success');
        }

        async function runFullDiagnostic() {
            clearLog();
            log('Starting full diagnostic...', 'info');

            await checkExtensionStatus();
            await checkModuleLoading();
            await checkClipboardAccess();
            await checkElementorDetection();
            await checkPasteInterceptor();

            log('Diagnostic complete!', 'success');
            showFixes();
        }

        async function checkExtensionStatus() {
            log('Checking extension status...');
            const statusDiv = document.getElementById('extension-status');
            statusDiv.innerHTML = '';

            // Check if chrome.runtime is available
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                addCheck(statusDiv, 'Chrome Extension API', false, 'chrome.runtime not available');
                log('ERROR: Chrome extension API not available', 'error');
                return;
            }
            addCheck(statusDiv, 'Chrome Extension API', true);
            log('‚úì Chrome extension API available', 'success');

            // Check extension ID
            try {
                const extensionId = chrome.runtime.id;
                addCheck(statusDiv, 'Extension ID', true, extensionId);
                log(`‚úì Extension ID: ${extensionId}`, 'success');
            } catch (e) {
                addCheck(statusDiv, 'Extension ID', false, e.message);
                log(`ERROR: Cannot get extension ID: ${e.message}`, 'error');
            }

            // Check if background script is responsive
            try {
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({ action: 'ping' }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(chrome.runtime.lastError);
                        } else {
                            resolve(response);
                        }
                    });
                    setTimeout(() => reject(new Error('Timeout')), 3000);
                });
                addCheck(statusDiv, 'Background Script', true, 'Responsive');
                log('‚úì Background script is responsive', 'success');
            } catch (e) {
                addCheck(statusDiv, 'Background Script', false, e.message);
                log(`ERROR: Background script not responding: ${e.message}`, 'error');
            }
        }

        async function checkModuleLoading() {
            log('Checking module loading...');
            const statusDiv = document.getElementById('module-status');
            statusDiv.innerHTML = '';

            const modules = [
                'ElementorFormatConverter',
                'ElementorEditorDetector',
                'ClipboardManager',
                'PasteInterceptor',
                'EditorContextInjector',
                'MediaURLHandler',
                'VersionCompatibilityManager',
                'ContentSanitizer',
                'NotificationManager'
            ];

            for (const moduleName of modules) {
                const exists = typeof window[moduleName] !== 'undefined';
                addCheck(statusDiv, moduleName, exists);
                if (exists) {
                    log(`‚úì ${moduleName} loaded`, 'success');
                } else {
                    log(`ERROR: ${moduleName} not loaded`, 'error');
                }
            }

            // Check for instances
            if (window.__elementorCopierInstances) {
                addCheck(statusDiv, 'Module Instances', true, 'Initialized');
                log('‚úì Module instances created', 'success');
            } else {
                addCheck(statusDiv, 'Module Instances', false, 'Not initialized');
                log('ERROR: Module instances not created', 'error');
            }
        }

        async function checkClipboardAccess() {
            log('Checking clipboard access...');
            const statusDiv = document.getElementById('clipboard-status');
            statusDiv.innerHTML = '';

            // Check clipboard API
            if (!navigator.clipboard) {
                addCheck(statusDiv, 'Clipboard API', false, 'Not available');
                log('ERROR: Clipboard API not available', 'error');
                return;
            }
            addCheck(statusDiv, 'Clipboard API', true);
            log('‚úì Clipboard API available', 'success');

            // Test clipboard read
            try {
                const text = await navigator.clipboard.readText();
                addCheck(statusDiv, 'Clipboard Read', true, `${text.length} chars`);
                log(`‚úì Clipboard read successful (${text.length} chars)`, 'success');
            } catch (e) {
                addCheck(statusDiv, 'Clipboard Read', false, e.message);
                log(`ERROR: Clipboard read failed: ${e.message}`, 'error');
            }

            // Test clipboard write
            try {
                await navigator.clipboard.writeText('test');
                addCheck(statusDiv, 'Clipboard Write', true);
                log('‚úì Clipboard write successful', 'success');
            } catch (e) {
                addCheck(statusDiv, 'Clipboard Write', false, e.message);
                log(`ERROR: Clipboard write failed: ${e.message}`, 'error');
            }

            // Check for extension clipboard data
            try {
                const clipText = await navigator.clipboard.readText();
                let hasExtensionData = false;
                try {
                    const data = JSON.parse(clipText);
                    hasExtensionData = data.type === 'elementor-copier';
                } catch (e) {
                    // Not JSON or not extension data
                }
                addCheck(statusDiv, 'Extension Data in Clipboard', hasExtensionData, hasExtensionData ? 'Found' : 'Not found');
                if (hasExtensionData) {
                    log('‚úì Extension clipboard data found', 'success');
                } else {
                    log('No extension data in clipboard (copy a widget first)', 'info');
                }
            } catch (e) {
                addCheck(statusDiv, 'Extension Data Check', false, e.message);
                log(`ERROR: Cannot check clipboard data: ${e.message}`, 'error');
            }
        }

        async function checkElementorDetection() {
            log('Checking Elementor detection...');
            const statusDiv = document.getElementById('elementor-status');
            statusDiv.innerHTML = '';

            // Check if we're in an Elementor page
            const hasElementorElements = document.querySelector('[data-elementor-type]') !== null;
            addCheck(statusDiv, 'Elementor Elements', hasElementorElements);
            if (hasElementorElements) {
                log('‚úì Elementor elements detected on page', 'success');
            } else {
                log('No Elementor elements found (not an Elementor page)', 'info');
            }

            // Check if we're in Elementor editor
            const isEditor = window.elementor !== undefined || window.elementorFrontend !== undefined;
            addCheck(statusDiv, 'Elementor Editor', isEditor);
            if (isEditor) {
                log('‚úì Elementor editor detected', 'success');

                // Check Elementor version
                if (window.elementor && window.elementor.config) {
                    const version = window.elementor.config.version;
                    addCheck(statusDiv, 'Elementor Version', true, version);
                    log(`‚úì Elementor version: ${version}`, 'success');
                }
            } else {
                log('Not in Elementor editor (paste only works in editor)', 'info');
            }

            // Check for editor detector instance
            if (window.__elementorCopierInstances && window.__elementorCopierInstances.editorDetector) {
                const detector = window.__elementorCopierInstances.editorDetector;
                const inEditor = detector.isElementorEditor();
                addCheck(statusDiv, 'Editor Detector', true, inEditor ? 'In editor' : 'Not in editor');
                log(`‚úì Editor detector: ${inEditor ? 'In editor' : 'Not in editor'}`, inEditor ? 'success' : 'info');
            } else {
                addCheck(statusDiv, 'Editor Detector', false, 'Not initialized');
                log('ERROR: Editor detector not initialized', 'error');
            }
        }

        async function checkPasteInterceptor() {
            log('Checking paste interceptor...');
            const statusDiv = document.getElementById('paste-status');
            statusDiv.innerHTML = '';

            // Check if paste interceptor exists
            if (!window.__elementorCopierInstances || !window.__elementorCopierInstances.pasteInterceptor) {
                addCheck(statusDiv, 'Paste Interceptor', false, 'Not initialized');
                log('ERROR: Paste interceptor not initialized', 'error');
                return;
            }

            const interceptor = window.__elementorCopierInstances.pasteInterceptor;
            addCheck(statusDiv, 'Paste Interceptor', true, 'Initialized');
            log('‚úì Paste interceptor initialized', 'success');

            // Check if initialized
            if (interceptor.initialized) {
                addCheck(statusDiv, 'Interceptor Status', true, 'Active');
                log('‚úì Paste interceptor is active', 'success');
            } else {
                addCheck(statusDiv, 'Interceptor Status', false, 'Not active');
                log('ERROR: Paste interceptor not active', 'error');
            }

            // Check dependencies
            const deps = {
                'Clipboard Manager': interceptor.clipboardManager,
                'Editor Detector': interceptor.editorDetector,
                'Editor Injector': interceptor.editorInjector,
                'Format Converter': interceptor.formatConverter
            };

            for (const [name, dep] of Object.entries(deps)) {
                const exists = dep !== null && dep !== undefined;
                addCheck(statusDiv, name, exists);
                if (exists) {
                    log(`‚úì ${name} available`, 'success');
                } else {
                    log(`ERROR: ${name} not available`, 'error');
                }
            }
        }

        async function testClipboard() {
            clearLog();
            log('Testing clipboard operations...');
            await checkClipboardAccess();
            log('Clipboard test complete', 'success');
        }

        async function testModules() {
            clearLog();
            log('Testing module loading...');
            await checkModuleLoading();
            log('Module test complete', 'success');
        }

        function addCheck(container, label, passed, details = '') {
            const item = document.createElement('div');
            item.className = 'check-item';

            const statusClass = passed ? 'pass' : 'fail';
            const statusText = passed ? 'PASS' : 'FAIL';

            item.innerHTML = `
        <strong>${label}</strong>
        <span class="status ${statusClass}">${statusText}</span>
        ${details ? `<div style="margin-top: 8px; color: #666; font-size: 13px;">${details}</div>` : ''}
      `;

            container.appendChild(item);
        }

        function showFixes() {
            const fixesDiv = document.getElementById('fixes');
            const fixes = [];

            // Analyze diagnostic log for issues
            const errors = diagnosticLog.filter(e => e.type === 'error');

            if (errors.length === 0) {
                fixesDiv.innerHTML = '<div class="check-item" style="background: #e8f5e9; border-color: #4caf50;"><strong>‚úì No issues detected!</strong><br>All systems are working correctly.</div>';
                return;
            }

            // Generate fixes based on errors
            errors.forEach(error => {
                if (error.message.includes('Background script')) {
                    fixes.push({
                        title: 'Background Script Not Responding',
                        steps: [
                            'Reload the extension from chrome://extensions',
                            'Check if the extension is enabled',
                            'Try restarting your browser',
                            'Reinstall the extension if issue persists'
                        ]
                    });
                }

                if (error.message.includes('Module') && error.message.includes('not loaded')) {
                    fixes.push({
                        title: 'Modules Not Loading',
                        steps: [
                            'Refresh the page (Ctrl+R or Cmd+R)',
                            'Check browser console for script loading errors',
                            'Verify all extension files are present',
                            'Clear browser cache and reload'
                        ]
                    });
                }

                if (error.message.includes('Clipboard')) {
                    fixes.push({
                        title: 'Clipboard Access Issues',
                        steps: [
                            'Grant clipboard permissions to the extension',
                            'Check browser settings: chrome://settings/content/clipboard',
                            'Make sure the page is focused (click on it)',
                            'Try using Ctrl+C and Ctrl+V manually'
                        ]
                    });
                }

                if (error.message.includes('Editor detector')) {
                    fixes.push({
                        title: 'Editor Detection Failed',
                        steps: [
                            'Make sure you are in Elementor edit mode (not preview)',
                            'Wait for Elementor editor to fully load',
                            'Refresh the page and try again',
                            'Check if Elementor is properly installed'
                        ]
                    });
                }

                if (error.message.includes('Paste interceptor')) {
                    fixes.push({
                        title: 'Paste Interceptor Not Working',
                        steps: [
                            'Refresh the Elementor editor page',
                            'Make sure you copied a widget first',
                            'Check that you are in edit mode (not preview)',
                            'Try clicking on a section/column before pasting'
                        ]
                    });
                }
            });

            // Remove duplicates
            const uniqueFixes = fixes.filter((fix, index, self) =>
                index === self.findIndex(f => f.title === fix.title)
            );

            if (uniqueFixes.length === 0) {
                fixesDiv.innerHTML = '<div class="check-item"><strong>No specific fixes available</strong><br>Check the diagnostic log for details.</div>';
                return;
            }

            fixesDiv.innerHTML = uniqueFixes.map(fix => `
        <div class="check-item" style="background: #fff3cd; border-color: #ffc107;">
          <strong>‚ö†Ô∏è ${fix.title}</strong>
          <ol style="margin: 10px 0 0 0; padding-left: 20px;">
            ${fix.steps.map(step => `<li>${step}</li>`).join('')}
          </ol>
        </div>
      `).join('');
        }

        // Auto-run on load if in Elementor editor
        window.addEventListener('load', () => {
            log('Diagnostic tool loaded');
            if (window.elementor || window.elementorFrontend) {
                log('Elementor detected - you can run diagnostics now', 'info');
            } else {
                log('Not in Elementor editor - some checks may not apply', 'info');
            }
        });
    </script>
</body>

</html>