<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor Injector Test Suite</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #666; margin-top: 0; }
    button {
      background: #0073aa;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #005a87; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .warning { background: #fff3cd; color: #856404; }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      padding: 2px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <h1>üß™ Editor Context Injector Test Suite</h1>
  <p>This test suite verifies the editor-injector.js module functionality.</p>

  <!-- Test 1: Initialization -->
  <div class="test-section">
    <h2>Test 1: Injector Initialization</h2>
    <p>Tests if the EditorContextInjector class can be instantiated and initialized.</p>
    <button onclick="runTest1()">Run Test</button>
    <div id="test1-result"></div>
  </div>

  <!-- Test 2: Script Injection -->
  <div class="test-section">
    <h2>Test 2: Script Injection</h2>
    <p>Tests if the injector can inject script into the main world.</p>
    <button onclick="runTest2()">Run Test</button>
    <div id="test2-result"></div>
  </div>

  <!-- Test 3: Message Bridge -->
  <div class="test-section">
    <h2>Test 3: Message Bridge Communication</h2>
    <p>Tests bidirectional communication between content script and injected script.</p>
    <button onclick="runTest3()">Run Test</button>
    <div id="test3-result"></div>
  </div>

  <!-- Test 4: Mock Elementor Environment -->
  <div class="test-section">
    <h2>Test 4: Mock Elementor Environment</h2>
    <p>Creates a mock Elementor environment and tests API access.</p>
    <button onclick="runTest4()">Run Test</button>
    <div id="test4-result"></div>
  </div>

  <!-- Test 5: Paste Trigger -->
  <div class="test-section">
    <h2>Test 5: Paste Trigger (Mock)</h2>
    <p>Tests the triggerElementorPaste function with mock data.</p>
    <button onclick="runTest5()">Run Test</button>
    <div id="test5-result"></div>
  </div>

  <!-- Test 6: Error Handling -->
  <div class="test-section">
    <h2>Test 6: Error Handling</h2>
    <p>Tests graceful error handling when operations fail.</p>
    <button onclick="runTest6()">Run Test</button>
    <div id="test6-result"></div>
  </div>

  <!-- Test 7: React Detection -->
  <div class="test-section">
    <h2>Test 7: React Component Detection</h2>
    <p>Tests detection of React components in the environment.</p>
    <button onclick="runTest7()">Run Test</button>
    <div id="test7-result"></div>
  </div>

  <!-- Console Log -->
  <div class="test-section">
    <h2>Console Log</h2>
    <div id="console-log" class="log"></div>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <script src="editor-injector.js"></script>
  <script>
    let injector = null;
    const logs = [];

    // Intercept console methods
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addLog(type, ...args) {
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      
      logs.push({ type, message, timestamp: new Date().toISOString() });
      updateLogDisplay();
      
      // Call original
      if (type === 'error') originalError(...args);
      else if (type === 'warn') originalWarn(...args);
      else originalLog(...args);
    }

    console.log = (...args) => addLog('log', ...args);
    console.error = (...args) => addLog('error', ...args);
    console.warn = (...args) => addLog('warn', ...args);

    function updateLogDisplay() {
      const logDiv = document.getElementById('console-log');
      logDiv.innerHTML = logs.map(log => 
        `<div class="log-entry">[${log.timestamp.split('T')[1].split('.')[0]}] [${log.type.toUpperCase()}] ${log.message}</div>`
      ).join('');
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      logs.length = 0;
      updateLogDisplay();
    }

    function showResult(testId, success, message, data = null) {
      const resultDiv = document.getElementById(`test${testId}-result`);
      const className = success ? 'success' : 'error';
      let html = `<div class="result ${className}">
        <strong>${success ? '‚úÖ PASS' : '‚ùå FAIL'}</strong>: ${message}
      `;
      
      if (data) {
        html += `\n\nData:\n${JSON.stringify(data, null, 2)}`;
      }
      
      html += '</div>';
      resultDiv.innerHTML = html;
    }

    // Test 1: Initialization
    async function runTest1() {
      try {
        injector = new EditorContextInjector();
        
        if (injector && typeof injector.initialize === 'function') {
          showResult(1, true, 'EditorContextInjector instantiated successfully', {
            hasSetupMessageBridge: typeof injector.setupMessageBridge === 'function',
            hasInjectScript: typeof injector.injectScript === 'function',
            hasTriggerElementorPaste: typeof injector.triggerElementorPaste === 'function',
            hasAccessElementorAPI: typeof injector.accessElementorAPI === 'function'
          });
        } else {
          showResult(1, false, 'Failed to instantiate EditorContextInjector');
        }
      } catch (error) {
        showResult(1, false, `Error: ${error.message}`);
      }
    }

    // Test 2: Script Injection
    async function runTest2() {
      try {
        if (!injector) {
          injector = new EditorContextInjector();
        }

        const result = await injector.injectScript();
        
        if (result) {
          // Check if script was actually injected
          const scriptExists = injector.injected;
          showResult(2, scriptExists, 'Script injected into main world', {
            injected: scriptExists,
            bridgeReady: injector.bridgeReady
          });
        } else {
          showResult(2, false, 'Script injection returned false');
        }
      } catch (error) {
        showResult(2, false, `Error: ${error.message}`);
      }
    }

    // Test 3: Message Bridge
    async function runTest3() {
      try {
        if (!injector || !injector.injected) {
          await runTest2();
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Test sending a message
        const version = await injector.getElementorVersion();
        
        showResult(3, true, 'Message bridge communication successful', {
          versionResponse: version,
          bridgeReady: injector.bridgeReady
        });
      } catch (error) {
        showResult(3, false, `Error: ${error.message}`);
      }
    }

    // Test 4: Mock Elementor Environment
    async function runTest4() {
      try {
        // Create mock Elementor object
        window.elementor = {
          config: {
            version: '3.16.0',
            document: { id: 123 }
          },
          loaded: true,
          channels: {
            clipboard: {
              reply: function(key, data) {
                console.log('Mock clipboard reply:', key, data);
              }
            }
          },
          getPreviewContainer: function() {
            return {
              view: {
                collection: { length: 0 }
              }
            };
          },
          selection: {
            getElements: function() {
              return [];
            }
          }
        };

        window.$e = {
          run: function(command, options) {
            console.log('Mock $e.run:', command, options);
            return true;
          }
        };

        if (!injector || !injector.injected) {
          await runTest2();
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Test API access
        const version = await injector.getElementorVersion();
        const isEditor = await injector.isEditorMode();
        
        showResult(4, version === '3.16.0' && isEditor, 'Mock Elementor environment working', {
          version,
          isEditor,
          elementorExists: !!window.elementor
        });
      } catch (error) {
        showResult(4, false, `Error: ${error.message}`);
      }
    }

    // Test 5: Paste Trigger
    async function runTest5() {
      try {
        if (!window.elementor) {
          await runTest4();
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        const mockElement = {
          elType: 'widget',
          widgetType: 'heading',
          id: 'test1234',
          settings: {
            title: 'Test Heading'
          },
          elements: [],
          isInner: false
        };

        const result = await injector.triggerElementorPaste(mockElement);
        
        showResult(5, result.success, 'Paste trigger executed', result);
      } catch (error) {
        showResult(5, false, `Error: ${error.message}`);
      }
    }

    // Test 6: Error Handling
    async function runTest6() {
      try {
        if (!injector || !injector.injected) {
          await runTest2();
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Test with invalid API path
        const result = await injector.accessElementorAPI('invalid.path.that.does.not.exist');
        
        // Should return null without throwing
        showResult(6, result === null, 'Error handled gracefully', {
          result,
          message: 'Invalid API path returned null as expected'
        });
      } catch (error) {
        showResult(6, false, `Unexpected error thrown: ${error.message}`);
      }
    }

    // Test 7: React Detection
    async function runTest7() {
      try {
        if (!injector || !injector.injected) {
          await runTest2();
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Mock React
        window.React = { version: '18.0.0' };
        window.ReactDOM = {};

        const reactInfo = await injector.detectReactComponents();
        
        showResult(7, reactInfo.hasReact, 'React detection working', reactInfo);
      } catch (error) {
        showResult(7, false, `Error: ${error.message}`);
      }
    }

    // Run all tests
    async function runAllTests() {
      console.log('=== Running All Tests ===');
      await runTest1();
      await new Promise(resolve => setTimeout(resolve, 300));
      await runTest2();
      await new Promise(resolve => setTimeout(resolve, 300));
      await runTest3();
      await new Promise(resolve => setTimeout(resolve, 300));
      await runTest4();
      await new Promise(resolve => setTimeout(resolve, 300));
      await runTest5();
      await new Promise(resolve => setTimeout(resolve, 300));
      await runTest6();
      await new Promise(resolve => setTimeout(resolve, 300));
      await runTest7();
      console.log('=== All Tests Complete ===');
    }

    // Add run all button
    window.addEventListener('DOMContentLoaded', () => {
      const runAllBtn = document.createElement('button');
      runAllBtn.textContent = '‚ñ∂Ô∏è Run All Tests';
      runAllBtn.style.cssText = 'background: #28a745; font-size: 16px; padding: 15px 30px; margin: 20px 0;';
      runAllBtn.onclick = runAllTests;
      document.body.insertBefore(runAllBtn, document.body.firstChild);
    });
  </script>
</body>
</html>
