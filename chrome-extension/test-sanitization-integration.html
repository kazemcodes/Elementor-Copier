<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sanitization Integration Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #92003b;
      padding-bottom: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .pass { color: #28a745; font-weight: bold; }
    .fail { color: #dc3545; font-weight: bold; }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    button {
      background: #92003b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #750030;
    }
    #summary {
      background: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>ðŸ”— Format Converter + Sanitizer Integration Test</h1>
  
  <div id="summary">
    <strong>Test Summary:</strong> <span id="summary-text">Click "Run Integration Tests" to begin</span>
  </div>

  <button onclick="runIntegrationTests()">Run Integration Tests</button>
  <button onclick="clearResults()">Clear Results</button>

  <div id="test-results"></div>

  <script src="content-sanitizer.js"></script>
  <script>
    // Make ContentSanitizer available globally for the format converter
    window.ContentSanitizer = ContentSanitizer;
  </script>
  <script src="elementor-format-converter.js"></script>
  <script>
    let totalTests = 0;
    let passedTests = 0;

    function clearResults() {
      document.getElementById('test-results').innerHTML = '';
      totalTests = 0;
      passedTests = 0;
      updateSummary();
    }

    function updateSummary() {
      const summaryText = document.getElementById('summary-text');
      if (totalTests === 0) {
        summaryText.textContent = 'Click "Run Integration Tests" to begin';
      } else {
        summaryText.innerHTML = `
          <span class="${passedTests === totalTests ? 'pass' : 'fail'}">
            ${passedTests}/${totalTests} tests passed
          </span>
        `;
      }
    }

    function addTestResult(title, passed, input, output, notes) {
      totalTests++;
      if (passed) passedTests++;

      const section = document.createElement('div');
      section.className = 'test-section';
      section.innerHTML = `
        <h2>${passed ? 'âœ“' : 'âœ—'} ${title}</h2>
        <p class="${passed ? 'pass' : 'fail'}">${passed ? 'PASSED' : 'FAILED'}</p>
        ${notes ? `<p><strong>Notes:</strong> ${notes}</p>` : ''}
        <details>
          <summary>View Details</summary>
          <h3>Input:</h3>
          <pre>${JSON.stringify(input, null, 2)}</pre>
          <h3>Output:</h3>
          <pre>${JSON.stringify(output, null, 2)}</pre>
        </details>
      `;
      document.getElementById('test-results').appendChild(section);
      updateSummary();
    }

    function runIntegrationTests() {
      clearResults();
      console.log('Running integration tests...');

      // Test 1: Malicious script in widget content
      test1_MaliciousScript();
      
      // Test 2: Dangerous URLs in settings
      test2_DangerousURLs();
      
      // Test 3: Event handlers in HTML content
      test3_EventHandlers();
      
      // Test 4: Nested elements with mixed content
      test4_NestedElements();
      
      // Test 5: CSS injection attempts
      test5_CSSInjection();
      
      // Test 6: Complete element with multiple attack vectors
      test6_MultipleAttacks();

      console.log(`Integration tests complete: ${passedTests}/${totalTests} passed`);
    }

    function test1_MaliciousScript() {
      const input = {
        data: {
          elType: 'widget',
          widgetType: 'text-editor',
          settings: {
            content: '<p>Safe content</p><script>alert("XSS")</script><p>More content</p>',
            title: 'My Widget'
          },
          elements: []
        },
        metadata: {
          elementorVersion: '3.5.0'
        }
      };

      try {
        const output = ElementorFormatConverter.convertToNativeFormat(input, {
          targetVersion: '3.5.0',
          sanitize: true
        });

        const outputStr = JSON.stringify(output);
        const passed = !outputStr.includes('<script') && !outputStr.includes('alert');
        
        addTestResult(
          'Test 1: Remove malicious script tags',
          passed,
          input,
          output,
          passed ? 'Script tags successfully removed' : 'Script tags still present!'
        );
      } catch (error) {
        addTestResult('Test 1: Remove malicious script tags', false, input, { error: error.message }, 'Error during conversion');
      }
    }

    function test2_DangerousURLs() {
      const input = {
        data: {
          elType: 'widget',
          widgetType: 'button',
          settings: {
            text: 'Click Me',
            url: 'javascript:alert(document.cookie)',
            link: {
              url: 'data:text/html,<script>alert(1)</script>'
            }
          },
          elements: []
        },
        metadata: {
          elementorVersion: '3.5.0'
        }
      };

      try {
        const output = ElementorFormatConverter.convertToNativeFormat(input, {
          targetVersion: '3.5.0',
          sanitize: true
        });

        const outputStr = JSON.stringify(output);
        const passed = !outputStr.includes('javascript:') && !outputStr.includes('data:text/html');
        
        addTestResult(
          'Test 2: Block dangerous URL protocols',
          passed,
          input,
          output,
          passed ? 'Dangerous URLs blocked' : 'Dangerous URLs still present!'
        );
      } catch (error) {
        addTestResult('Test 2: Block dangerous URL protocols', false, input, { error: error.message }, 'Error during conversion');
      }
    }

    function test3_EventHandlers() {
      const input = {
        data: {
          elType: 'widget',
          widgetType: 'heading',
          settings: {
            title: '<h2 onclick="alert(1)" onmouseover="steal()">Heading</h2>',
            content: '<div onload="bad()">Content</div>'
          },
          elements: []
        },
        metadata: {
          elementorVersion: '3.5.0'
        }
      };

      try {
        const output = ElementorFormatConverter.convertToNativeFormat(input, {
          targetVersion: '3.5.0',
          sanitize: true
        });

        const outputStr = JSON.stringify(output);
        const passed = !outputStr.includes('onclick') && 
                      !outputStr.includes('onmouseover') && 
                      !outputStr.includes('onload');
        
        addTestResult(
          'Test 3: Remove event handler attributes',
          passed,
          input,
          output,
          passed ? 'Event handlers removed' : 'Event handlers still present!'
        );
      } catch (error) {
        addTestResult('Test 3: Remove event handler attributes', false, input, { error: error.message }, 'Error during conversion');
      }
    }

    function test4_NestedElements() {
      const input = {
        data: {
          elType: 'section',
          settings: {
            background_color: '#fff'
          },
          elements: [
            {
              elType: 'column',
              settings: {
                _column_size: 50
              },
              elements: [
                {
                  elType: 'widget',
                  widgetType: 'text-editor',
                  settings: {
                    content: '<iframe src="evil.com"></iframe><p>Safe text</p>'
                  },
                  elements: []
                },
                {
                  elType: 'widget',
                  widgetType: 'image',
                  settings: {
                    image: {
                      url: 'javascript:void(0)'
                    }
                  },
                  elements: []
                }
              ]
            }
          ]
        },
        metadata: {
          elementorVersion: '3.5.0'
        }
      };

      try {
        const output = ElementorFormatConverter.convertToNativeFormat(input, {
          targetVersion: '3.5.0',
          sanitize: true
        });

        const outputStr = JSON.stringify(output);
        const passed = !outputStr.includes('<iframe') && !outputStr.includes('javascript:');
        
        addTestResult(
          'Test 4: Sanitize nested element structures',
          passed,
          input,
          output,
          passed ? 'All nested elements sanitized' : 'Some dangerous content remains!'
        );
      } catch (error) {
        addTestResult('Test 4: Sanitize nested element structures', false, input, { error: error.message }, 'Error during conversion');
      }
    }

    function test5_CSSInjection() {
      const input = {
        data: {
          elType: 'widget',
          widgetType: 'heading',
          settings: {
            title: 'Heading',
            style: 'background: url(javascript:alert(1)); color: red;',
            custom_css: 'body { behavior: url(xss.htc); }'
          },
          elements: []
        },
        metadata: {
          elementorVersion: '3.5.0'
        }
      };

      try {
        const output = ElementorFormatConverter.convertToNativeFormat(input, {
          targetVersion: '3.5.0',
          sanitize: true
        });

        const outputStr = JSON.stringify(output).toLowerCase();
        const passed = !outputStr.includes('javascript:') && !outputStr.includes('behavior:');
        
        addTestResult(
          'Test 5: Remove CSS injection attempts',
          passed,
          input,
          output,
          passed ? 'CSS sanitized successfully' : 'Dangerous CSS patterns remain!'
        );
      } catch (error) {
        addTestResult('Test 5: Remove CSS injection attempts', false, input, { error: error.message }, 'Error during conversion');
      }
    }

    function test6_MultipleAttacks() {
      const input = {
        data: {
          elType: 'widget',
          widgetType: 'text-editor',
          settings: {
            content: `
              <div onclick="steal()">
                <script>alert('xss')</script>
                <iframe src="evil.com"></iframe>
                <img src="x" onerror="bad()">
                <a href="javascript:void(0)">Link</a>
                <style>body { behavior: url(xss.htc); }</style>
              </div>
            `,
            url: 'data:text/html,<script>alert(1)</script>',
            custom_style: 'background: url(javascript:alert(1))'
          },
          elements: []
        },
        metadata: {
          elementorVersion: '3.5.0'
        }
      };

      try {
        const output = ElementorFormatConverter.convertToNativeFormat(input, {
          targetVersion: '3.5.0',
          sanitize: true
        });

        const outputStr = JSON.stringify(output).toLowerCase();
        const checks = [
          { pattern: '<script', name: 'script tags' },
          { pattern: '<iframe', name: 'iframe tags' },
          { pattern: 'onclick', name: 'onclick handlers' },
          { pattern: 'onerror', name: 'onerror handlers' },
          { pattern: 'javascript:', name: 'javascript: URLs' },
          { pattern: 'data:text/html', name: 'data: URLs' },
          { pattern: 'behavior:', name: 'CSS behavior' }
        ];

        const failed = checks.filter(check => outputStr.includes(check.pattern));
        const passed = failed.length === 0;
        
        const notes = passed 
          ? 'All attack vectors successfully blocked' 
          : `Failed to block: ${failed.map(f => f.name).join(', ')}`;
        
        addTestResult(
          'Test 6: Block multiple attack vectors',
          passed,
          input,
          output,
          notes
        );
      } catch (error) {
        addTestResult('Test 6: Block multiple attack vectors', false, input, { error: error.message }, 'Error during conversion');
      }
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      console.log('Integration test suite loaded');
      console.log('ContentSanitizer available:', typeof ContentSanitizer !== 'undefined');
      console.log('ElementorFormatConverter available:', typeof ElementorFormatConverter !== 'undefined');
    });
  </script>
</body>
</html>
