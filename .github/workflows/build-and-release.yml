name: Build and Release Extension

on:
  push:
    branches:
      - main
    paths:
      - 'chrome-extension/**'
      - 'build-extension.ps1'
      - '.github/workflows/build-and-release.yml'
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from manifest
        id: get_version
        shell: pwsh
        run: |
          $manifest = Get-Content -Path "chrome-extension/manifest.json" -Raw | ConvertFrom-Json
          $version = $manifest.version
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Extension version: $version"

      - name: Check if release exists
        id: check_release
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $releases = gh release list --limit 100
          $exists = $releases | Select-String -Pattern "v$version"
          if ($exists) {
            echo "RELEASE_EXISTS=true" >> $env:GITHUB_OUTPUT
            echo "Release v$version already exists"
          } else {
            echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
            echo "Release v$version does not exist"
          }
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build extension
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        shell: pwsh
        run: |
          .\build-extension.ps1

      - name: Create Release
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Elementor Copier v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## üéâ Elementor Copier v${{ steps.get_version.outputs.VERSION }}
            
            ### ‚ö†Ô∏è Important: Download the Correct File
            
            **Download this file:** `elementor-copier-v${{ steps.get_version.outputs.VERSION }}.zip` (see Assets below)
            
            **DO NOT download:** "Source code (zip)" or "Source code (tar.gz)" - these are NOT the extension!
            
            üëâ [Not sure which file? Read the download guide](https://github.com/kazemcodes/Elementor-Copier/blob/main/RELEASE_DOWNLOAD_GUIDE.md)
            
            ### üì¶ Installation Instructions
            1. Download the ZIP file above
            2. Extract the ZIP file
            3. Open Chrome and go to `chrome://extensions/`
            4. Enable "Developer mode" (toggle in top-right)
            5. Click "Load unpacked"
            6. Select the extracted `chrome-extension` folder
            7. The extension is now installed! üéâ
            
            ### ‚ú® What's New
            See [CHANGELOG.md](https://github.com/kazemcodes/Elementor-Copier/blob/main/CHANGELOG.md) for complete details.
            
            ### üíù Support Development
            If you find this extension helpful, consider supporting development:
            
            **Bitcoin (BTC):** `bc1qwncc5gfrzt0hwhwt9ad9vyv6eg8gxk4wlg6atm`
            
            Your support helps maintain and improve this free extension!
            
            ---
            
            **Note:** This extension is distributed through GitHub only. It's completely free and open-source.
          files: |
            releases/elementor-copier-v${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
          generate_release_notes: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip release creation
        if: steps.check_release.outputs.RELEASE_EXISTS == 'true'
        run: |
          echo "Release v${{ steps.get_version.outputs.VERSION }} already exists. Skipping release creation."
