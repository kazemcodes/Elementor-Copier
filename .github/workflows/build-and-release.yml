name: Build and Release Extension

on:
  push:
    branches:
      - main
    paths:
      - 'chrome-extension/**'
      - 'build-extension.ps1'
      - '.github/workflows/build-and-release.yml'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from manifest
        id: get_version
        shell: pwsh
        run: |
          $manifest = Get-Content -Path "chrome-extension/manifest.json" -Raw | ConvertFrom-Json
          $version = $manifest.version
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Extension version: $version"

      - name: Check if release exists
        id: check_release
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $releases = gh release list --limit 100
          $exists = $releases | Select-String -Pattern "v$version"
          if ($exists) {
            echo "RELEASE_EXISTS=true" >> $env:GITHUB_OUTPUT
            echo "Release v$version already exists"
          } else {
            echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
            echo "Release v$version does not exist"
          }
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build extension
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        shell: pwsh
        run: |
          .\build-extension.ps1

      - name: Create Release
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Elementor Copier v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Elementor Copier v${{ steps.get_version.outputs.VERSION }}
            
            ### Installation Instructions
            1. Download `elementor-copier-v${{ steps.get_version.outputs.VERSION }}.zip`
            2. Extract the ZIP file
            3. Open Chrome and go to `chrome://extensions/`
            4. Enable "Developer mode" (toggle in top-right)
            5. Click "Load unpacked"
            6. Select the extracted `chrome-extension` folder
            
            ### What's New
            See [CHANGELOG.md](https://github.com/kazemcodes/elementor-copy/blob/main/CHANGELOG.md) for details.
            
            ### Support
            If you find this extension helpful, consider supporting development:
            **Bitcoin**: `bc1qwncc5gfrzt0hwhwt9ad9vyv6eg8gxk4wlg6atm`
          files: |
            releases/elementor-copier-v${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip release creation
        if: steps.check_release.outputs.RELEASE_EXISTS == 'true'
        run: |
          echo "Release v${{ steps.get_version.outputs.VERSION }} already exists. Skipping release creation."
